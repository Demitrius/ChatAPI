<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <script type="text/javascript" src="js/ac-cc-api-locale-ru.js"></script>
    <script type="text/javascript" src="js/ac-cc-api.js"></script>
<style>
    body {
	font-family: arial;
    }
    p {
	color: #333;
	line-height: 1.3em;
    }
    .btn {
	background: #D6D4D4;
	display: inline-block;
        padding: 7px 14px;
	border-radius: 20px;
        cursor: pointer;
	color: #333;
    }
    .row {
        border: 1px solid #A7A7A7;
	border-bottom: 3px solid #A7A7A7;
        padding: 20px 20px;
	padding-top: 0;
	margin: 10px 20px;
        border-radius: 3px;
    }
    .title {
	background: #A7A7A7;
        margin-left: -20px;
	margin-right: -20px;
	margin-bottom: 20px;
        padding: 5px;
        color: white;
    }
    .screen {
	display: inline-block;
	width: 320px;
	margin: 20px;
	vertical-align: top;
	position: relative;
    }
    .screen .refresh {
	position: absolute;
	bottom: 100%;
	right: 0;
	font-size: 13px;
	padding-bottom: 4px;
	cursor: pointer;
	opacity: 0.7;
    }
    .screen .head {
	color: white;
	background: #373E4A;
	padding: 18px 30px;
        font-size: 19px;
	text-align: center;
    }
    .screen .body {
	height: 422px;
	border: 1px solid silver;
	border-top: 0;
	overflow: auto;
    }
    .admin-block {
	padding: 7px 14px;
	position: relative;
	cursor: pointer;
    }
    .avatar {
	width: 46px;
	height: 46px;
	border-radius: 50%;
	margin-right: 15px;
    }
    .indicator {
	width: 10px;
	height: 10px;
	position: absolute;
	left: 50px;
	border-radius: 50%;
	top: 36px;
	border: 2px solid white;
    }
    .indicator.offline {
	background: #B5B5B5;
    }
    .indicator.signin {
	background: #7A5EFF;
    }
    .indicator.online {
	background: #1FAD00;
    }

    div.preview {
	border: 5px solid white;
	margin: 10px;
        display: inline-block;
        box-shadow: 0 1px 2px rgba(0,0,0,0.3);
	position: relative;
        font-size: 0px;
	line-height: 0;
        background-color: white;
        background-image: url(/cc/img/FW/jcc-bgtr.svg);
	background-size: 20px 20px;
    }
    img.preview-min {
	max-width:200px;
        max-height:200px;
	vertical-align: middle;
        background: white;
    }

    div.jcc-dialog-left-msg, div.jcc-dialog-right-msg {
        font-size: 13px !important;
	line-height: 1.33em;
	word-break: break-word;
	-moz-text-size-adjust: 100%;
	-webkit-text-size-adjust: 100%;
	-ms-text-size-adjust: 100%;
	text-size-adjust: 100%;
        letter-spacing: normal;
	white-space: normal;
	text-indent: 0;
        -webkit-tap-highlight-color: transparent;
	max-width: 80%;
    }
    div.jcc-dialog-right-msg:first-child {
	border-radius: 14px 4px 14px 14px;
    }
    div.jcc-dialog-right-msg {
	color: #3a3b3c;
        text-shadow: 0px 1px 0px rgba(255,255,255,0.0);
        /*margin: 7px;*/
	margin: 5px 10px;
	m1argin-left: 50px;
        border-radius: 20px;
	display: inline-block;
        background-color: #efefef;
	border: 1px solid #efefef;
        box-shadow: 0px 4px 0px rgba(178,178,178,0.0), inset 0px 0px 0px rgba(255,255,255,0.0);
        position: relative;
	text-align: right;
        /*padding: 15px 20px;*/
	/*padding: 8px 13px 10px 17px;*/
	padding: 7px 14px;
	min-width: 20px;
	background: -moz-linear-gradient(top, #efefef 0%, #efefef 100%);
	background: -webkit-gradient(linear, left top, left bottom, color-stop(0%,#efefef), color-stop(100%,#efefef));
        background: -webkit-linear-gradient(top, #efefef 0%,#efefef 100%);
	background: -o-linear-gradient(top, #efefef 0%,#efefef 100%);
        background: -ms-linear-gradient(top, #efefef 0%,#efefef 100%);
	background: linear-gradient(to bottom, #efefef 0%,#efefef 100%);
    }
    div.jcc-dialog-left-msg:first-child {
        border-radius: 4px 14px 14px 14px;
    }
    div.jcc-dialog-left-msg {
	color: #3a3b3c;
	text-shadow: 0px 1px 0px rgba(255,255,255,0.0);
        /*margin: 7px;*/
	margin: 5px 10px;
	ma1rgin-right: 50px;
	border-radius: 20px;
        display: inline-block;
	border: 1px solid #ccdbe4;
        box-shadow: 0px 4px 0px rgba(0,0,0,0.0), inset 0px 0px 0px rgba(255,255,255,0.0);
        position: relative;
        text-align: left;
	/*padding: 15px 20px;*/
	/*padding: 8px 17px 10px 13px;*/
	padding: 7px 14px;
        min-width: 20px;
        background-color: #ccdbe4;
	background: -moz-linear-gradient(top, #ccdbe4 0%, #ccdbe4 100%);
        background: -webkit-gradient(linear, left top, left bottom, color-stop(0%,#ccdbe4), color-stop(100%,#ccdbe4));
	background: -webkit-linear-gradient(top, #ccdbe4 0%,#ccdbe4 100%);
        background: -o-linear-gradient(top, #ccdbe4 0%,#ccdbe4 100%);
	background: -ms-linear-gradient(top, #ccdbe4 0%,#ccdbe4 100%);
	background: linear-gradient(to bottom, #ccdbe4 0%,#ccdbe4 100%);
    }

    .progress {
	height: 20px;
	margin-bottom: 20px;
	overflow: hidden;
	background-color: #f5f5f5;
	border-radius: 4px;
	-webkit-box-shadow: inset 0 1px 2px rgba(0,0,0,.1);
	box-shadow: inset 0 1px 2px rgba(0,0,0,.1);
    }
    .progress-bar {
	float: left;
	width: 0;
	height: 100%;
	font-size: 12px;
	line-height: 20px;
	color: #fff;
	text-align: center;
	background-color: #337ab7;
	-webkit-box-shadow: inset 0 -1px 0 rgba(0,0,0,.15);
	box-shadow: inset 0 -1px 0 rgba(0,0,0,.15);
	-webkit-transition: width .6s ease;
	-o-transition: width .6s ease;
	transition: width .6s ease;
    }

</style>
<script language="JavaScript">

// Global vars
var brand_id = 3;			// AC Partner Identificator (3 is MTX). !!! Define static value before public app.
var cloud_addr = 'im.matrixtelecom.ru';	// Partners proxy address. !!! Define static value before public app.
var device_model = 'Samsung S9';	// Device model name. Operator will see in cabinet his devices by model name.
var device_serial = 'jeke21uw2e';	// Device serial number. It can be proc serial, board serial, any number which not changed when app reinstalled.
var app_version = '1.0';		// Use it for protocol compatible in future.

// Login and pass. Get from form.
var g_login = 'test3';
var g_password = 'test1212';
var g_signin_params = {
    push_config: {"device_id": "1271e23d-b38f-4cd2-b122-2564774131e3"},
    push_service: 1,
    brand: brand_id,
    dev_model: device_model,
    dev_serial: device_serial,
    app_ver: app_version
};
// Default lang 'ru', but next version get lang from SignIn Form
var g_lang = 'ru';

var cb_process_messages;

var sel_rid = 0;
var sel_aid = 0;
var sel_vid = 0;
var sel_sid = 0;
var sel_sut = 0;

function ready() {

    cb_process_messages = function(x) {
	console.log('cb_process_messages');
	console.log(x);

	////////////////////////////////////////////////////////////////////////////////
	// Authorization (SignIn result)
	////////////////////////////////////////////////////////////////////////////////
	if (x.s == 0 && x.v == 1) { /* Success */ }
	if (x.s == 0 && x.v == 2) { /* Invalid login or password */ }
	if (x.s == 0 && x.v == 3) { /* Need reuse confirmation */ } // Not happens in this version
	if (x.s == 0 && x.v == 4) { /* Internal error */ } // Show message - We are sorry, try again later.
	if (x.s == 0 && x.v == 5) { /* Account blocked */ } // Show message same as Invalid pass
	if (x.s == 0 && x.v == 6) { /* ASI auth failed */ } // Show message same as Invalid pass. Not used in this version

	////////////////////////////////////////////////////////////////////////////////
	// Visitors (Web-Online mode)
	////////////////////////////////////////////////////////////////////////////////
	// WEB-ONLINE activated. Full list of visitors.
	if (x.s == 1 && x.v == 10) {
	    if (x.list) {
		if (typeof x.nac !== 'undefined' && x.nac.length > 0) {
		    UpdateQueuedChats();
		}
	    }
	}
	// Updates for visitors. New visit (change url) and other activities
	if (x.s == 1 && x.v == 20) {
	    // nothing to do
	}

	////////////////////////////////////////////////////////////////////////////////
	// Users. Event happen when success login or users changed (new user, delete user, change name etc)
	// Update local array with users and GUI if need.
	////////////////////////////////////////////////////////////////////////////////
	if (x.s == 3 && x.v == 10) {
	    UpdateUserList();
	}
	////////////////////////////////////////////////////////////////////////////////
	// Users. Event happen when user status changed (user login, logout, turn web-online etc)
	// Update local array with users and GUI if need.
	////////////////////////////////////////////////////////////////////////////////
	if (x.s == 3 && x.v == 20) {
	    UpdateUserList();

	    // Some changes in Virtual queues. New/Del/Changes
	    if (x.qinfo) {
		UpdateVirtualQueuesList();
	    }
	}

	////////////////////////////////////////////////////////////////////////////////
	// Chats. Events
	////////////////////////////////////////////////////////////////////////////////
	if (x.s == 3 && x.v == 30) {
	    UpdateDialogList();

	    // Clear typing hint
    	    var __the = document.getElementById('typing-hint');
    	    if (__the) { __the.innerHTML = ''; __the.style.display = 'none'; }

	    // Send back read notify if room openned (sel_rid == x.r) and not my msg and not system (10)
	    // For mobile version we must check chat screen is active now and not in popup menu
	    // If chat openned and user view popup info (roll over ...), don't send read and send it when user back to chat wall.
	    if (sel_rid == x.r && ((x.msg.ut == 1 && x.msg.mid != ApixCloud.CC.API.GetConfig().mid) || (x.msg.ut != 1 && x.msg.ut != 10))) {
	        ApixCloud.CC.API.SendReadNotification(sel_rid, x.msg.id);
    	    } else {
		// Chat not openned or openned another chat.
		// Just notice user - you have new message.
		// x.r - room id

		// send back delivery notify if not my msg and not system (10)
		if ((x.msg.ut == 1 && x.msg.mid != ApixCloud.CC.API.GetConfig().mid) || (x.msg.ut != 1 && x.msg.ut != 10)) {
		    ApixCloud.CC.API.SendDeliveryNotification(x.r, x.msg.id);
    		}
    	    }

	    // Update sel_* variables
	    if (x.msg.mid == 150) {
		// User in chat (operator)
		var a = x.msg.body.split(':');
		sel_sid = a[0];
		sel_sut = a[1];
	    }

	    if (x.msg.mid == 130) {
		sel_sid = x.msg.tm.m;
		sel_sut = x.msg.tm.u;
	    } else if (x.msg.mid == 135) {
		sel_sid = 0;
		sel_sut = 0;
	    }

	    if (sel_rid > 0 && sel_rid == x.r) P3_d3(x.r);
	}
	if (x.s == 3 && x.v == 40) {
	    P3_n1(x);
	    UpdateDialogList();
	    if (sel_rid > 0 && sel_rid == x.r) P3_d3(x.r);
	}
	if (x.s == 3 && x.v == 50) {
	    P3_r2(x);
	}

	////////////////////////////////////////////////////////////////////////////////
	// Virtual Queues
	////////////////////////////////////////////////////////////////////////////////
	if (x.s == 3 && x.v == 80) {
	    UpdateVirtualQueuesList();
	}

	////////////////////////////////////////////////////////////////////////////////
	// Session closed. Event happen when user logout, when someone block/delete user and etc
	// Update GUI if need and show message about logout reason.
	////////////////////////////////////////////////////////////////////////////////
	if (x.s == 0 && x.v == 100) {
console.log('LOGOUT by '+x.r);
	    // Show message for reason and then open SignIn screen
	    // close_by_reuse
	    // - en - (title) Successfully Logged out; (message) The user logged in from another device.
	    // - ru - Сеанс завершен; Пользователь выполнил вход с другого устройства.
	    // close_by_admin
	    // - en - Session closed; The session was closed by the administrator
	    // - ru - Сеанс прерван; Сеанс был прерван администратором.
	    // close_by_delete
	    // - en - Account Closed; The session was interrupted for security reasons.
	    // - ru - Учётная запись закрыта; Сеанс прерван в целях безопастности.
	    // close_by_block
	    // - en - Account Blocked; The session was interrupted for security reasons.
	    // - ru - Учётная запись заблокирована; Сеанс прерван в целях безопастности.
	    // close_by_logout
	    // - en - (title) Successfully Logged out; (message) You have successfully logged out of your account.
	    // - ru - Сеанс завершен; Вы успешно вышли из своего аккаунта.

	    // clear screens
	    document.getElementById('admins').innerHTML = '';
	    document.getElementById('queues').innerHTML = '';
	    document.getElementById('my_dialogs').innerHTML = '';
	    document.getElementById('dialog').innerHTML = '';
	}

	////////////////////////////////////////////////////////////////////////////////
	// Statistics
	////////////////////////////////////////////////////////////////////////////////
	if (x.s == 0 && x.v == 320) {
	    switch (x.t) {
		case 16530: {
console.log(x);
		    for (var i = 0; i < x.aa.length; i++) { // >
			// Update User popover if it open
			var o = document.getElementById('user_popover_'+x.aa[i].aid);
			if (o) {
			    // Update statistics
			    // Received Chats or 0
			    o = document.getElementById('user_popover_chats_'+x.aa[i].aid);
			    if (o) o.innerHTML = x.aa[i].di.cnt > 0 ? x.aa[i].di.cnt : 0;
			    // Chats without answer or 0
			    o = document.getElementById('user_popover_mdc_'+x.aa[i].aid);
			    if (o) o.innerHTML = x.aa[i].mdc > 0 ? x.aa[i].mdc : 0;
			    // Missed dialogs or 0
			    o = document.getElementById('user_popover_mqc_'+x.aa[i].aid);
			    if (o) o.innerHTML = x.aa[i].mqc > 0 ? x.aa[i].mqc : 0;
			    // Rating or 0
			    o = document.getElementById('user_popover_rating_'+x.aa[i].aid);
			    if (o) o.innerHTML = x.aa[i].di.adr > 0 ? x.aa[i].di.adr : 0;
			    // Thumb Up/Down
			    o = document.getElementById('user_popover_tu_'+x.aa[i].aid);
			    if (o) o.innerHTML = x.aa[i].dvi.tu > 0 ? x.aa[i].dvi.tu : 0;
			    o = document.getElementById('user_popover_td_'+x.aa[i].aid);
			    if (o) o.innerHTML = x.aa[i].dvi.td > 0 ? x.aa[i].dvi.td : 0;
			    // Answer time and Reaction speed
			    var __aat = '-';
			    if (x.aa[i].aat != null && typeof x.aa[i].aat !== 'undefined') __aat = x.aa[i].aat + ' '+ACC.L[217];
			    var __art = '-';
			    if (x.aa[i].art != null && typeof x.aa[i].art !== 'undefined') __art = x.aa[i].art + ' '+ACC.L[217];
			    o = document.getElementById('user_popover_aat_'+x.aa[i].aid);
			    if (o) o.innerHTML = __aat;
			    o = document.getElementById('user_popover_art_'+x.aa[i].aid);
			    if (o) o.innerHTML = __art;

			}
		    }

		} break;
	    }
	}

    }

    // Initialize API
    ApixCloud.CC.API.Initialize(cloud_addr, 'ru', cb_process_messages);

}
function sign_in() {
    // SignIn
    ApixCloud.CC.API.SignIn(g_login, g_password, g_signin_params, g_lang);
}
function sign_out() {
    // SignOut
    ApixCloud.CC.API.SignOut();
}
function stackTrace() {
    var err = new Error();
    console.log(err.stack);
};


/////////////////////////////////////////////////
// Display chat in queue
function qmc(d) {
    var aqm = ApixCloud.CC.API.GetQueuedChats();
    var ol = ApixCloud.CC.API.GetUsers();
    var vl = ApixCloud.CC.API.GetVisitors();

    // Start timer to hilight how older message: green - red - brown
    var o = document.getElementById('queue-cnt-'+aqm[d].q);
    var b = document.createElement('div');
    b.setAttribute('id','qm-btn'+d);
    var t = '';
    var l = '';
    var lca = '';
    var ahp = 'margin-right:20px;margin-left:10px;';

    b.className = 'qm-color jcc-oper-btn-off';
    b.setAttribute('onclick', 'tqm('+d+','+aqm[d].idq+','+aqm[d].d+')');
    b.setAttribute('style', 'background-color: #00a651 !important; border-bottom: 1px solid #007338;');

    // Get visitor lang
    if (aqm[d].lid && ApixCloud.CC.API.GetConfig().cl.length > 1) {
	if (typeof ApixCloud.CC.API.GetConfig().sl[aqm[d].lid] !== 'undefined') {
	    l = '<span style="padding: 3px 9px;border-radius: 11px;background-color: #8383FF;margin-left: 10px;font-size: 12px;" id="qm-btn-l'+d+'" class="badge badge-info avatar-badge lang-badge" title="'+decodeURIComponent(ApixCloud.CC.API.GetConfig().sl[aqm[d].lid].n)+'">'+ApixCloud.CC.API.GetConfig().sl[aqm[d].lid].c.toUpperCase()+'</span>';
	}
    }
    // Last agent chat
    if (aqm[d].lca > 0 && typeof ol[aqm[d].lca] !== 'undefined') {
	lca = '<div style="background-size:cover;border-radius:50%;border:0;width:30px;height:30px;background-image:url('+'//'+cloud_addr+'/avatar'+ol[aqm[d].lca].ap+');position:absolute;right:-20px;margin:0;top:50%;margin-top:-15px;" class="oper_btn_avatar"></div>';
	if (!l) ahp = 'margin-right:28px;margin-left:2px;';
    }

    // Get Title info for queued chat
    var qi = ApixCloud.CC.API.GetQueuedChatInfo(d);

    t += '<table border="0" cellpadding="0" cellspacing="0" width="100%"> \
	<tbody><tr> \
	    <td width="1" style="padding-top:10px;padding-bottom:10px;padding-right:10px;"><div style="position:relative;background-size:cover;border-radius:50%;border:0;width:40px;height:40px;background-image:url('+qi.a+');'+ahp+'">'+lca+'</div></td> \
	    <td valign="middle" style="padding-left:3px;position:relative;"> \
		<div style="position:block;left:0;right:0;top:0;bottom:0;overflow:hidden;text-overflow:ellipsys;"> \
		    <div class="txt-title-s3" style="text-overflow:ellipsis;overflow:hidden;color:white;">'+qi.n+'</div> \
		    <div class="txt-title-s2" id="jcc-qm-btn-s'+d+'" style="transition:color 5s ease;padding-top:1px;text-overflow:ellipsis;overflow:hidden;color:#DEDEDE;">'+qi.dn+l+'</div> \
		</div> \
		<div style="position:absolute;right:15px;top:20px;padding:3px 5px;border-radius:12px;" class="qm-tc" id="qmb-t-'+d+'"></div> \
	</td></tr></tbody></table>';

    if (!aqm[d].mct) {
	aqm[d].mcti = 0;
	aqm[d].mct = setInterval(function(_d) { return function() { var dd = _d; qmt(dd); };}(d), 1000);
    }
    b.innerHTML = t;
    if (o) o.appendChild(b);
};
function qmt(d) {
    var aqm = ApixCloud.CC.API.GetQueuedChats();
    if (aqm[d].mcti < 7777777) aqm[d].mcti++;

    var o = document.getElementById('qmb-t-'+d);
    var dutc = new Date((new Date()).toUTCString());

    if (o) o.innerHTML = T_i(((dutc.getTime() / 1000) - aqm[d].st));

    o = document.getElementById('qm-btn'+d);
    if (!o) return;
    dv = '';
    if (aqm[d].mcti == 30) {
	// BG & Border
	if (o.style.display == 'none') dv = 'display:none;';
	o.setAttribute('style','background-color:#fad839 !important;border-bottom:1px solid #d7b205;'+dv);
	// Site
	o = document.getElementById('jcc-qm-btn-s'+d);
	o.style.color = '#949494';
    }
    dv = '';
    if (aqm[d].mcti == 60) {
	// BG
	if (o.style.display == 'none') dv = 'display:none;';
	o.setAttribute('style','background-color:#ec5956 !important;border-bottom:1px solid #C74440;'+dv);
	// Site
	o = document.getElementById('jcc-qm-btn-s'+d);
	o.style.color = '#DEDEDE';
    }
    dv = '';
    if (aqm[d].mcti == 90) {
	if (o.style.display == 'none') dv = 'display:none;';
	o.setAttribute('style','background-color:#cc2424 !important;border-bottom:1px solid #a81919;'+dv);
    }
};
function T_i(sec) {
    var d = 0;
    var h = 0;
    var m = 0;
    var s = 0;
    var r = '';

    s = sec;

    // > 1 day
    if (s >= 86400) {
	d = parseInt(s / 86400);
	s = s - (86400 * d);
    }
    if (s >= 3600) {
	h = parseInt(s / 3600);
	s = s - (h * 3600);
    }
    if (s >= 60) {
	m = parseInt(s / 60);
	s = s - (m * 60);
    }
    
    if (s < 10) { s = '0' + s; }

    // Return format: DD, HH:MM:SS
    if (d > 0) {
	if (m < 10) { m = '0' + m; }
	r = '' + d + ', ' + h + ':'+ m + ':' + s;
    } else if (h > 0) {
	if (m < 10) { m = '0' + m; }
	r = '' + h + ':'+ m + ':' + s;
    } else {
	r = '' + m + ':' + s;
    }

    return r;
}

// Take chat from queue
function tqm(a, b, c) {
    ApixCloud.CC.API.TakeChatFromQueue(a, b, c)
};

// Change my available status (Web-Online)
function cas() {
    ApixCloud.CC.API.ChangeAvailableStatus();
};
euc = function(x) {
    return encodeURIComponent(x).replace(/[!'()]/g, JCC.eucf); //'
};
eucf = function(x) {
    switch(x) {
	case '[': return '%5B';
	case '!': return '%21';
	case '\'': return '%27';
	case '(': return '%28';
	case ')': return '%29';
	case ']': return '%5D';
	default: return x;
    }
};

// room_id, msg, class (active/not)
function ddt1(d, m, c) {
    var o;    
    var ap = '';
    var tt = '';
    var ts = '';
    var ut;
    var id;
    var prsi;
    var ol = ApixCloud.CC.API.GetUsers();
    var vl = ApixCloud.CC.API.GetVisitors();
    var rl = ApixCloud.CC.API.GetChatRooms();

    var dti = ApixCloud.CC.API.GetDialogTitleInfo(d, m);
    ap = dti.ap;
    ts = dti.ts;
    prsi = dti.prsi;
    tt = dti.tt;
    ut = dti.ut;
    id = dti.id;

    var li = document.createElement('div')
    li.className = 'dc';
    li.setAttribute('id', 'jcc-d'+d+'-tab');
    li.setAttribute('uut', ut);
    li.setAttribute('uid', id);
    li.setAttribute('rid', d);

    // Unread messages
    var rl = ApixCloud.CC.API.GetChatRooms();
    var nmb = '';
    // Logic: show counter if : we have um and um member not me and um counter > 0
    if (typeof rl[d] !== 'undefined' && typeof rl[d].um !== 'undefined' && !(rl[d].um.ut == 1 && rl[d].um.mid == ApixCloud.CC.API.GetConfig().mid) && rl[d].um.mc > 0) {
	nmb = '<span class="badge" style="position: absolute;right: 30px;top: 50%;margin-top: -10px; background: #21A9E1; color: white; padding: 3px 7px; text-align: center;font-size: 13px;border-radius: 50%;">'+rl[d].um.mc+'</span>';
    }

    li.innerHTML = '<div id="jcc-d'+d+'-btn" style="display: table; table-layout: fixed; width: 100%;"> \
    <div id="jcc-d'+d+'-btn2" onclick="OpenDialog('+d+','+ut+',\''+id+'\', \''+encodeURIComponent(tt)+'\', \''+ts+'\', \''+ap+'\');"> \
    <div class="d1 txt-title-s3" style="position:relative;vertical-align: top;border-bottom: 1px solid #E8E8E8;"> \
			<div id="jcc-vt'+d+'-avail-flag" class="jcc-prs-avflag '+prsi+'"></div> \
			'+nmb+' \
			<div style="position: absolute;right: 10px; top: 50%; margin-top: -9px;">&gt;</div> \
			<img border="0" width="26" height="26" style="margin: 10px 15px;vertical-align: top;" class="avatar" src="'+ap+'"> \
			<div id="jcc-d'+d+'-tab-title" class="dbt txt-title-s3" style="font-weight: 600;color:inherit;white-space:nowrap;text-overflow:ellipsis;overflow:hidden;display: inline-block;padding-top: 15px;">'+tt+' \
			    <br><span style="font-weight: 300;font-size: 14px;">'+decodeURIComponent(ts)+'</span></div> \
			</div></div></div>';

    o = document.getElementById('my_dialogs');
    if (o) {
	o.appendChild(li);
    }
    return {ap:ap, tt:encodeURIComponent(tt), ts:ts};
}

function ShowDialogMenu() {
    var rl = ApixCloud.CC.API.GetChatRooms();
    var o = document.getElementById('chat-control-menu');
    var t = '';

    // Add this menu items if chat openned
    if (sel_rid > 0) {
	if (typeof rl[sel_rid] !== 'undefined' && rl[sel_rid].s == 1) {
	    // Transfer. This options avail for simple chat (s = 1) and not avail for conference (s = 2)
	    t += '<div style="margin-bottom:7px;cursor:pointer;"><span style="margin-right:10px;float:left;">?</span><span>'+ACC.L[47]+'</span><span style="margin-right:10px;float:right;">></span></div>';
	    t += '<div style="margin-bottom: 20px;">'+P3_t5()+'</div>';
	}
	// Conference
        t += '<div style="margin-bottom:7px;cursor:pointer;"><span style="margin-right:10px;float:left;">?</span><span>'+ACC.L[48]+'</span><span style="margin-right:10px;float:right;">></span></div>';
	t += '<div style="margin-bottom: 20px;">'+P3_t6()+'</div>';
    }

    // In the future
    // Some other menu items like Audio/Video calls
    // Menu items for visitors: bann, history (visits, calls, chats, emails and etc sorted in timeline)


    // Close chat item if chat openned. Always last menu item.
    if (sel_rid > 0) {
	// Close Chat, if chat openned
	t += '<div onclick="CloseChatRoom()" style="margin-bottom:7px;cursor:pointer;"><span style="margin-right:10px;float:left;">x</span><span>'+ACC.L[46]+'</span></div>';
    }

    o.innerHTML = t;

    if (o.style.display == 'block') o.style.display = 'none';
    else o.style.display = 'block';
}
// Build transfer menu
function P3_t5() {
    var ol = ApixCloud.CC.API.GetUsers();
    var rl = ApixCloud.CC.API.GetChatRooms();
    var q = ApixCloud.CC.API.GetVirtualQueues();
    var og = ApixCloud.CC.API.GetDepartments();

    var html = ''; // HTML for menu

    // Interoper dialog or with Visitor
    var cwv = 0;
    var dc = 0;
    if (sel_rid > 0 && typeof rl[sel_rid] !== 'undefined') {
	dc = rl[sel_rid].domid;
	for (var i = 0; i < rl[sel_rid].m.length; i++) if (rl[sel_rid].m[i].ut > 1) { cwv = 1; break; }
    }

    // Queues. Available only for chats with visitors. dc > 0 if chat from external channel, not interoperator.
    if (q && dc > 0) {
	html += '<div style="text-align:center; opacity:0.5">'+ACC.L[101]+'</div>';
	for (var i in q) {
	    html += '<div style="cursor: pointer;" onclick="P3_t5i(' + q[i].id + ', 100);"><i class="entypo-flow-tree">@</i> ' + decodeURIComponent(q[i].qn) + '</div>';
	}
    }

    // Add admins (in groups if exists)
    var olk = Object.keys(ol);
    var oig;
    var oc;
    if (og && og.length > 0) {
	for (var i = 0; i < og.length; i++) {

	    // add admins, crt grp, not me, not companion, online
	    oig = '';
	    oc = 0;
	    for (var ii = 0; ii < olk.length; ii++) {
		if (ol[olk[ii]].gid != og[i].gid) continue;
		if (ol[olk[ii]].id == ApixCloud.CC.API.GetConfig().mid) continue;
		if (ol[olk[ii]].helper) continue;
		if (sel_aid > 0 && ol[olk[ii]].id == sel_aid) continue;
		if (sel_sut == 1 && sel_sid > 0 && ol[olk[ii]].id == sel_sid) continue;
		if (ol[olk[ii]].st != 1) continue;
		if (ol[olk[ii]].was != 1 && cwv == 1) continue;

		var av = '<div style="background-size:cover;border-radius: 50%;display:inline-block;vertical-align:middle;border:0;width:24px;height:24px;margin:2px;background-image:url(//'+cloud_addr + '/avatar' + ol[olk[ii]].ap+');margin-right:10px;" class="oper_btn_avatar"></div>';
		oig += '<div style="cursor: pointer;" onclick="P3_t5i(' + ol[olk[ii]].id + ', 1);">'+av + ApixCloud.CC.API.GetUserName(ol[olk[ii]].id) + '</div>';
    		oc++;
	    }
	    
	    if (oc > 0) {
		// add group title
		html += '<div style="text-align:center; opacity:0.5">'+decodeURIComponent(og[i].name)+'</div>';
		// add users
		html += oig;
	    }
	}
    }
    return html;
};
// Transfer to
function P3_t5i(mid, mut) {
    if (sel_rid > 0) {
	ApixCloud.CC.API.TransferChatRoom(sel_rid, mid, mut);
    } else { alert('No chat room'); }
};

// Build conference menu
function P3_t6() {
    var ol = ApixCloud.CC.API.GetUsers();
    var rl = ApixCloud.CC.API.GetChatRooms();
    var og = ApixCloud.CC.API.GetDepartments();

    var html = ''; // HTML for menu
    html += '';

    // Local dialog or with Visitor
    var cwv = 0;
    if (sel_rid > 0 && typeof rl[sel_rid] !== 'undefined')
	for (var i = 0; i < rl[sel_rid].m.length; i++) if (rl[sel_rid].m[i].ut > 1) { cwv = 1; break; }


    // Add admins (in groups if exists)
    var olk = Object.keys(ol);
    var oig;
    var oc;
    var is_member = false;
    if (og && og.length > 0) {
	for (var i = 0; i < og.length; i++) {

	    // add admins, crt grp, not me, not companion, online
	    oig = '';
	    oc = 0;
	    for (var ii = 0; ii < olk.length; ii++) {
		if (ol[olk[ii]].gid != og[i].gid) continue;
		if (ol[olk[ii]].id == ApixCloud.CC.API.GetConfig().mid) continue;
		if (ol[olk[ii]].helper) continue;
		if (sel_sut == 1 && sel_sid > 0 && ol[olk[ii]].id == sel_sid) continue;
		if (ol[olk[ii]].st != 1) continue;
		if (ol[olk[ii]].was != 1 && cwv == 1) continue;
		if (sel_aid > 0 && ol[olk[ii]].id == sel_aid && rl[sel_rid].s == 1) continue;

		// exclude conference members
		is_member = false;
		if (sel_rid && rl[sel_rid] && rl[sel_rid].s == 2 && rl[sel_rid].m.length > 0) {
		    for (var iii = 0; iii < rl[sel_rid].m.length; iii++) {
			if (rl[sel_rid].m[iii].mid == ol[olk[ii]].id && rl[sel_rid].m[iii].ut == 1) {
			    is_member = true;
			    break;
			}
		    }
		}
		if (is_member) continue;

		var av = '<div style="background-size:cover;border-radius: 50%;display:inline-block;vertical-align:middle;border:0;width:24px;height:24px;margin:2px;background-image:url(//'+cloud_addr+'/avatar' + ol[olk[ii]].ap+');margin-right:10px;" class="oper_btn_avatar"></div>';
		oig += '<div style="cursor: pointer;" onclick="P3_t6i(' + ol[olk[ii]].id + ', 1);" class="txt-title-s3 dlgctl-fwd-itm">'+av + ApixCloud.CC.API.GetUserName(ol[olk[ii]].id) + '</div>';
    		oc++;
	    }
	    
	    if (oc > 0) {
		// add group title
		html += '<div style="text-align:center; opacity:0.5">'+decodeURIComponent(og[i].name)+'</div>';
		// add users
		html += oig;
	    }
	}
    }
    return html;
};

// Invite to conference
function P3_t6i(mid, mut) {
    if (sel_rid > 0) {
	ApixCloud.CC.API.InviteToConference(sel_rid, mid, mut);
    } else { alert('No chat room'); }
};

function DialogPanelHtml(ap, tt, ts) {
    return '<span style="float: left;margin-left: -10px;">&lt;</span> \
	    <img onclick="DialogInfoMenu()" border="0" width="20" height="20" style="cursor:pointer;margin-right: -15px;vertical-align: top;width: 32px;height: 32px;margin-top: -5px;margin-bottom: -5px;float: right;" class="avatar" src="'+ap+'"> \
	    <div style="margin-top: -5px;margin-bottom: -6px;line-height: 0.8em;"> \
		<div style="display: inline-block;cursor:pointer;" onclick="ShowDialogMenu()"> \
		    <span style="font-size: 16px;">'+decodeURIComponent(tt)+'</span> \
		    <br> \
	    	    <span style="font-size: 13px;opacity: 0.7;">'+decodeURIComponent(ts)+'</span> \
		</div> \
	    </div><div id="chat-control-menu" style="font-size:15px;z-index:1;text-align:left;display:none;position: absolute; background: silver; left: 0px; top: 58px; right: 0px; padding: 10px;"></div>';
}

function OpenDialog(r, ut, id, tt, ts, ap) {
    var rl = ApixCloud.CC.API.GetChatRooms();
    var o, t;

    if (r > 0) {
	// Open dialog room
	// Update head
	o = document.getElementById('dialog-head');
	o.innerHTML = DialogPanelHtml(ap, tt, ts);
console.log('OpenDialog '+ut);
	sel_rid = r;
	sel_sid = id;
	sel_sut = ut;

	if (rl[sel_rid] && rl[sel_rid].msgs) {
	    P3_d3(sel_rid);
	} else {
	    ApixCloud.CC.API.GetChatRoomMessages(sel_rid);
	}
    } else {
	// Open empty dialog
	sel_rid = 0;
	sel_sid = id;
	sel_sut = ut;
	// Update head
        o = document.getElementById('dialog-head');
	o.innerHTML = DialogPanelHtml(ap, tt, ts);
console.log('2-OpenDialog '+ut);
	P3_new_dialog();
    }
}
// Display new dialog screen
function P3_new_dialog() {
    var o = document.getElementById('dialog');
    o.innerHTML = '<div style="padding: 50px 0px; text-align:center">'+ACC.L[536]+'</div>';
};

// Display full dialog
function P3_d3(d, e, r) {
    var o;
    var lastm;
    var rm;

    o = document.getElementById('dialog');
    o.innerHTML = '';
    rm = ApixCloud.CC.API.GetChatRooms()[d];

    var ma = [];
    var lm = rm.msgs[0].mid;
    var lu = rm.msgs[0].ut;
    
    rm.rid = rm.msgs[0].rid;
    rm.rut = rm.msgs[0].rut;
    rm.sid = rm.msgs[0].sid;
    rm.sut = rm.msgs[0].sut;
    ApixCloud.CC.API.SetChatRoomOwners(rm.id, rm.msgs[0]);

    for (var m = 0; m < rm.msgs.length; m++) {
	lastm = rm.msgs[m];
	
	if (lm != rm.msgs[m].mid || lu != rm.msgs[m].ut) {
	    if (ma.length > 0) {
		// display array
		P3_d2(ma, o, 2, rm);
	    }
	    ma = [];
	}
	ma.push(rm.msgs[m]);
	lm = rm.msgs[m].mid;
	lu = rm.msgs[m].ut;
    }

    if (ma.length > 0) {
	// display last array
        P3_d2(ma, o, 2, rm);
    }

    if (!rm.et) {
	// update read/delivery in displayed dialog
//        JCC.P3.u2(d);
    
        // display typing hints
        P3_st(d);

	// send back read notify
        if (d && ((lastm.ut == 1 && lastm.mid != ApixCloud.CC.API.GetConfig().mid) || (lastm.ut != 1 && lastm.ut != 10)) && lastm.read != 1) {
	    ApixCloud.CC.API.SendReadNotification(d, lastm.id);
	}
    }

    return;
};

function P3_dim(p1) {
    var r = 'iM';

    if (p1.sut == 1 && p1.sid == ApixCloud.CC.API.GetConfig().mid) {
	r = 'iS';
    }
    if (p1.rut == 1 && p1.rid == ApixCloud.CC.API.GetConfig().mid) {
	r = 'iR';
    }
    
    return r;
};

// Vivesti v chitabelniy vid dannie, peredannie v chat pered nachalom.
// x1 can be JSON or simple string
function eps(x1) {
    var o, t = '';
    try {
	o = JSON.parse(decodeURIComponent(decodeURIComponent(x1)));
	if (o instanceof Array) {
	    for (var i = 0; i < o.length; i++) {
		t += '<tr><td style="color:#373e4a;font-weight:400;padding:0;padding-right:20px;">'+o[i].n+ '</td><td style="padding:0;">'+o[i].v+'</td></tr>';
	    }
	} else {
	    for (var k in o) {
		if (o.hasOwnProperty(k)) {
    		    t += '<tr><td style="color:#373e4a;font-weight:400;padding:0;padding-right:20px;">'+k+ '</td><td style="padding:0;">' + o[k]+'</td></tr>';
		}
	    }
	}
	if (t) t = '<table style="margin:auto;margin-top:10px;text-align:left;">'+t+'</table>';
    } catch (e) {
	t = '<div style="font-weight:400;margin-top:10px;">'+decodeURIComponent(x1)+'</div>';
    }

    return t;
};


// Display message. ma=MessageArray, p=Parent, l=last(show read/delivery hint), ds=DataStyle, ro=room object
function P3_d2(ma, p, ds, ro) {
    var ol = ApixCloud.CC.API.GetUsers();
    var vl = ApixCloud.CC.API.GetVisitors();
    //var rl = ApixCloud.CC.API.GetChatRooms();
    var t;
    var lds = ds;
    if (!lds) {	lds = 2; }
    var i = ma[0].ut +'-'+ma[0].mid;

    switch (ma[0].ut) {
	// System message
        case 10: {
	    for (var m = 0; m < ma.length; m++) {
		var mt;
		var mb = '';
		var ai = '';
		var op = '1';
		var h = 16;
		var eti = '';

		if (ma[m].smt) mt = ma[m].smt; else if (ma[m].et) mt = ma[m].et;
		
		if (ma[m].mid == 100 || ma[m].mid == 130) {
		    // Update sender/recipient for room
		    ro.rid = ma[m].rid;
		    ro.rut = ma[m].rut;
		    ro.sid = ma[m].sid;
		    ro.sut = ma[m].sut;
		    ro.m = ma[m].m;
		    ApixCloud.CC.API.SetChatRoomOwners(ro.id, ma[m]);
		}

		// ??? or delete some code for mid100 msg?
		if (ma[m].mid == 100 && ro.et) { return; }

		if (ma[m].mid == 101 && ma[m].body) {
		    ai = eps(ma[m].body);
		    mb = ACC.L[500];
		}
		if (ma[m].mid == 120) {
		    // member leave dialog
		    mb = ACC.L[175].replace('%person%', ApixCloud.CC.API.GetUserName(null, null, ma[m].mi));
		}
		if (ma[m].mid == 122) {
		    // member open dialog
		    mb = ACC.L[208].replace('%person%', ApixCloud.CC.API.GetUserName(null, null, ma[m].mi));
		}
		if (ma[m].mid == 134) {
		    // prepare to transfer chat to queue by not delivery
		    mb = ACC.L[489];
		}
		if (ma[m].mid == 138) {
		    mb = ACC.L[491];
		}

		if (ma[m].mid == 142) {
		    // Add new member
		    var a = ma[m].body.split(':');
		    a[0] = parseInt(a[0]); a[1] = parseInt(a[1]);
		    if (ro.m && ro.m.filter(function(_m, _u){ return function(e){if (e.mid==_m && e.ut==_u) return true;};}(a[0], a[1])).length == 0) ro.m.push({"mid":a[0], "ut":a[1]});
		    if (a[1] == 1) {
			mb = ACC.L[64].replace('%person%', ApixCloud.CC.API.GetUserName(a[0]));
		    }
		}
		if (ma[m].mid == 144) {
		    // One member leave conference
		    var a = ma[m].body.split(':');
		    a[0] = parseInt(a[0]); a[1] = parseInt(a[1]);
		    for (var ii = 0; ii < ro.m.length; ii++) { if (ro.m[ii].mid == a[0] && ro.m[ii].ut == a[1]) { ro.m.splice(ii, 1); } }
		    if (a[1] == 1) {
			mb = ACC.L[65].replace('%person%', ApixCloud.CC.API.GetUserName(a[0]));
		    }
		}

		if (ma[m].mid == 150) {
		    // Taked message by admin
		    var a = ma[m].body.split(':');
		    a[0] = parseInt(a[0]); a[1] = parseInt(a[1]);
		    if (ro.m && ro.m.filter(function(_m, _u){ return function(e){if (e.mid==_m && e.ut==_u) return true;};}(a[0], a[1])).length == 0) ro.m.push({"mid":a[0], "ut":a[1]});
		    if (a[1] == 1) {
			mb = ACC.L[99].replace('%person%', ApixCloud.CC.API.GetUserName(a[0]));
		    }
		}
		if (ma[m].mid == 190) {
		    // End of dialog
		    if (ro.s == 2) { mb = ACC.L[102]; } else { mb = ACC.L[103]; }
		}

		if (ma[m].mid == 100) {
		    mt = ma[m].st; op = '1';
		    mb = '';
		}

		if (ma[m].body && ma[m].body.length > 0 && !mb) { mb = ma[m].body; } else {
		    if (ma[m].mid == 110) { mb = ACC.L[42]; }
		}

		if (mb != '' || ((ma[m].fm && ma[m].tm)||(ma[m].fm && ma[m].tq))) {
		    h += 16;
		    if (ma[m].mid == 130) {
			h += 16;
			
			var f = '';
			if (ma[m].fm.dc > 1) f = ma[m].fm.d +', ';
			if (ma[m].fm.a.fn) f += ma[m].fm.a.fn +' ';
			if (ma[m].fm.a.ln) f += ma[m].fm.a.ln;
			var t = '';
			if (ma[m].tm.dc > 1) t = ma[m].tm.d +', ';
			if (ma[m].tm.a.fn) t += ma[m].tm.a.fn +' ';
			if (ma[m].tm.a.ln) t += ma[m].tm.a.ln;

			ai = decodeURIComponent(f)+'<span style="height: 10px; background: url(/img/dialog-transfer-10.svg) 50% 50% no-repeat; opacity:0.35; margin-left: 5px; margin-right: 5px; padding-left: 20px;"></span>'+decodeURIComponent(t);
			mb = ACC.L[100];
		    } else if (ma[m].mid == 135) {
			h += 16;
			
			var f = '';
			if (ma[m].fm.dc > 1) f = ma[m].fm.d +', ';
			if (ma[m].fm.a.fn) f += ma[m].fm.a.fn +' ';
			if (ma[m].fm.a.ln) f += ma[m].fm.a.ln;
			var t = '';
			if (ma[m].tq.qn) t += ma[m].tq.qn;

			ai = decodeURIComponent(f)+'<span style="height: 10px; background: url(/img/dialog-transfer-10.svg) 50% 50% no-repeat; opacity: 0.35; margin-left: 5px; margin-right: 5px; padding-left: 20px;"></span>'+decodeURIComponent(t);
			mb = ACC.L[101];
		    }
		}
		
		if (ma[m].mid == 160) {
		    // Use Lang = try room lang/CC lang/en/first avail
		    var ul = ApixCloud.CC.API.GetConfig().sl[ro.lid].c;
		    var af = ApixCloud.CC.API.GetForms();
		    if (!af[ma[m].fid].fc.f[0].h[ul]) {
			ul = g_lang;
			if (!af[ma[m].fid].fc.f[0].h[ul]) {
			    if (af[ma[m].fid].fc.f[0].h['en']) ul = 'en'; else  ul = Object.keys(af[ma[m].fid].fc.f[0].h)[0];
			}
		    }
		    mb = ACC.L[173];
		    ai = '<div class="frs" on1click="JCC.P3.off('+ma[m].fid+',\''+ul+'\', null);"><img src="/cc/img/'+JCC.theme+'/jcc-icon-fill-form.svg" style="vertical-align:top"><span class="txt-title-s3" style="margin-left:10px;">'+decodeURIComponent(JCC.P3.af[ma[m].fid].fc.title[ul])+'</span></div>';
		}
		if (ma[m].mid == 162) {
		    mb = ACC.L[174];
		}
		if (ma[m].mid == 170) {
		    mb = ACC.L[467]
		}
		if (ma[m].mid == 200) {
		    var _x1 = mb.split(':');
		    if (mb.indexOf('IS') == 0) {
			// Initiate upload. Progress 0%.
			ai = '<div id="cuft-'+_x1[3]+'">'+P3_gui(mb, ro)+'</div>';
		        mb = ACC.L[352];
		    }
		    if (mb.indexOf('UC') == 0) {
			// Upload complete
			_e_ifs = null;
			var o = document.getElementById('cuft-'+_x1[3]);
			if (o) {
			    // Remove IS message from array if avail
			    for (var _i = 0; _i < ro.msgs.length; _i++) {
				if (ro.msgs[_i].ut == 10 && ro.msgs[_i].mid == 200 && ro.msgs[_i].body.indexOf(':'+_x1[3]+':') > 0) {
				    ro.msgs.splice(_i, 1);
				}
			    }
			    o.innerHTML = P3_gui(mb, ro);
			    alert(ACC.L[363] +' - '+ ACC.L[367]);
			    ai = '';
			    mb = '{{SKIP}}';
			} else {
			    ai = P3_gui(mb, ro);
			    mb = ACC.L[352];
			}
		    }
		}

		if (eti == '') eti = gt(mt, 1);
		if (ai != '') eti += '<br>'+ai;
		if (mb != '{{SKIP}}') t = '<table border="0" cellpadding="0" cellspacing="0" width="100%" style="opacity: '+op+'; margin-top: 20px; margin-bottom: 20px; height: 16px; posit2ion: absolute; left: 0px;"> \
		        <tr><td align="center" style="padding:0;"><span class="jcc-sm" style="font-size:13px;color: rgba(0,0,0,0.5);font-weight:600;width: 80%;">' + mb + '</span></td></tr> \
			<tr><td align="center" style="padding:0;"><span class="jcc-sm" style="font-size:13px;color: rgba(0,0,0,0.5);font-weight:300;display:block;width: 80%;">' + eti + '</span></td></tr> \
		    </table>';
		else t = '';

		if (p && t) { p.innerHTML += t; }
	    }
	} break;

	case 1: {
	    var md = '';

	    // Left or Right?
	    // If my message = alway right
	    // If my companion = always left
	    // If not = check member - chetniy/ne chetniy if members > 2
	    var mp = ma[0].body.substring(0, 2);
	    // Who I am. Sender, Recipient, Member (aka Supervisor)
	    var iam = P3_dim(ro);

	    // If I as sender and message from any sender
	    if (iam == 'iS' && mp == 'S:') {
		md = 'right';
	    }
	    if (iam == 'iS' && mp == 'R:') {
		md = 'left';
	    }

	    if (iam == 'iR' && mp == 'S:') {
		md = 'left';
	    }
	    if (iam == 'iR' && mp == 'R:') {
		md = 'right';
	    }

	    if ((iam == 'iS' || iam == 'iR') && mp == 'M:') {
		// left/right detect by member sequence (chetniy nechetniy)???
		md = 'left';
	    }

	    if (iam == 'iM' && mp == 'S:') {
		md = 'left';
	    }
	    if (iam == 'iM' && mp == 'R:') {
		md = 'right';
	    }
	    if (iam == 'iM' && mp == 'M:') {
		// Im member and msg from me or other member
		// left/right detect by member sequence (chetniy nechetniy)???
		md = 'right';
	    }

	    // Visitors messages always left
	    if (ma[0].ut == 2) {
		md = 'left';
	    }

    		t = '<div style="white-space: nowrap;text-align:'+md+';"> \
			<div style="display: inline-block;float:'+md+';"> \
			    <div class="oper_btn_avatar" style="margin: auto;margin-top: 0px;margin-bottom:0px;width: 30px; height: 30px; box-sizing: content-box;"> \
				<img style="border: 0px solid; border-radius:50%;" src="'+'//'+cloud_addr+'/avatar' + ol[ma[0].mid].ap + '" height="30" width="30"/> \
		            </div> \
			    <div class="txt-title-s2" style="font-size:13px;opacity:0.5;">' + decodeURIComponent(ol[ma[0].mid].fn) + '</div> \
			</div> \
			<div style="padding-left: 10px;padding-right: 10px;margin-'+md+':4px;white-space: normal;display: inline-block;" class="msgcnt"> \
		    ';

    	    var pmt = ma[0].st; // Time of message
    	    var pmid = ma[0].id; // Id
    	    var mt = '';
	    var ms = '';
	    for (var m = 0; m < ma.length; m++) {		
		// Insert inside body smiles
		var mb = decodeURIComponent(ma[m].body.substring(2));
		// Replace tag to stringable
		mb=mb.replace(/</g,'&lt;');mb=mb.replace(/>/g,'&gt;');
		// Replace \n to <br>
		mb=mb.replace(/\n/g,'<br>');
		// smiley
		if (ApixCloud.CC.API.GetConfig().sse == '1') { mb = P3_se(mb); }
		// hilight links & show images
		mb = ApixCloud.CC.API.DetectDataInMessage(mb) + ' ';

		// if my message, show delivered/read status
		ms = '';
		if (ma[m].ut == 1 && ma[m].mid == ApixCloud.CC.API.GetConfig().mid) {
		    if (ma[m].dt > 0) {
			ms += ' | D ' + gt(ma[m].dt, lds);
		    }
		    if (ma[m].rt > 0) {
			ms += ' | R ' + gt(ma[m].rt, lds);
		    }
		}

		mt += '<div class="jcc-dialog-'+md+'-msg txt-title-s3 ac-msg-zoom-'+md+' show" style="text-align: left;">'+mb+' <div class="txt-title-s1 msg-time" style="font-size:10px;opacity:0.4;">'+gt(pmt, lds)+ms+'</div></div><br>';

		pmt = ma[m].st;
		pmid = ma[m].id;
	    }
	    t += mt + '</div></div>';

	    if (p) { p.innerHTML += t; }
	} break;

	case 200:
	case 201:
	case 2: {
	    var md = '';

	    // Left or Right?
	    // If my message = alway right
	    // If my companion = always left
	    // If not = check member - chetniy/ne chetniy if members > 2
	    var mp = ma[0].body.substring(0, 2);
	    // Who I am. Sender, Recipient, Member (aka Supervisor)
	    var iam = P3_dim(ro);
	    
	    // If I as sender and message from any sender
	    if (iam == 'iS' && mp == 'S:') {
		md = 'right';
	    }
	    if (iam == 'iS' && mp == 'R:') {
		md = 'left';
	    }

	    if (iam == 'iR' && mp == 'S:') {
		md = 'left';
	    }
	    if (iam == 'iR' && mp == 'R:') {
		md = 'right';
	    }

	    if ((iam == 'iS' || iam == 'iR') && mp == 'M:') {
		// left/right detect by member sequence (chetniy nechetniy)???
		md = 'left';
	    }

	    if (iam == 'iM' && mp == 'S:') {
		md = 'left';
	    }
	    if (iam == 'iM' && mp == 'R:') {
		md = 'right';
	    }
	    if (iam == 'iM' && mp == 'M:') {
		// Im member and msg from me or other member
		// left/right detect by member sequence (chetniy nechetniy)???
		md = 'right';
	    }

	    // Visitors messages always left
	    if (ma[0].ut == 2 || ma[0].ut == 200 || ma[0].ut == 201) {
		md = 'left';
	    }

    	    var vfn;
	    var __ap;
	    if (ma[0].ut == 200 || ma[0].ut == 201) {
	        if (typeof ro.mmbrs !== 'undefined' && ro.mmbrs.length > 0) for (var __i = 0; __i < ro.mmbrs.length; __i++) {
		    if ((ro.mmbrs[__i].u == 200 || ro.mmbrs[__i].u == 201) && ro.mmbrs[__i].m == ma[0].mid && ro.mmbrs[__i].a) {
			vfn = decodeURIComponent(ro.mmbrs[__i].a.fn);
			__ap = '//'+cloud_addr+'/avatar/a/vt/avt-0-0.svg';
			if (ro.mmbrs[__i].a.afn) __ap = ro.mmbrs[__i].a.afn;
			break;
		    }
		}    
	    } else {
    		if (typeof vl[ma[0].mid+'-'+ro.domid] !== 'undefined' && vl[ma[0].mid+'-'+ro.domid][0].fn) vfn = decodeURIComponent(vl[ma[0].mid+'-'+ro.domid][0].fn);
    		if (!vfn) {
		    if (typeof vl[ma[0].mid+'-'+ro.domid] !== 'undefined' && vl[ma[0].mid+'-'+ro.domid][0].cn) {
			vfn = decodeURIComponent(vl[ma[0].mid+'-'+ro.domid][0].cn);
		    } else {
			vfn = ACC.L[7];
		    }
		}
		__ap = '//'+cloud_addr+'/avatar/a/vt/avt-0-0.svg';
		if (typeof vl[ma[0].mid+'-'+ro.domid] !== 'undefined') __ap = '//'+cloud_addr+'/avatar'+vl[ma[0].mid+'-'+ro.domid][0].ap;
	    }




    		t = '<div style="white-space: nowrap;text-align:'+md+';"> \
			<div style="display: inline-block;float:'+md+';"> \
			    <div class="oper_btn_avatar" style="margin: auto;margin-top: 0px;margin-bottom:0px;width: 30px; height: 30px; box-sizing: content-box;"> \
				<img style="border: 0px solid; border-radius:50%;" src="'+__ap+'" height="30" width="30"/> \
		            </div> \
			    <div class="txt-title-s2" style="font-size:13px;opacity:0.5;">' + vfn + '</div> \
			</div> \
			<div style="padding-left: 10px;padding-right: 10px;margin-'+md+':4px;white-space: normal;display: inline-block;" class="msgcnt"> \
		    ';



    	    var pmt = ma[0].st;
	    var pmid = ma[0].id;
    	    var mt = '';
	    for (var m = 0; m < ma.length; m++) {
		// Insert inside body smiles
		var mb = decodeURIComponent(ma[m].body.substring(2));
		// Replace tag to stringable
		mb=mb.replace(/</g,'&lt;');mb=mb.replace(/>/g,'&gt;');
		// Replace \n to <br>
		mb=mb.replace(/\n/g,'<br>');
		// smiley
		if (ApixCloud.CC.API.GetConfig().sse == '1') { mb = P3_se(mb); }
		// hilight links & show images
		mb = ApixCloud.CC.API.DetectDataInMessage(mb) + ' ';

		mt += '<div class="jcc-dialog-'+md+'-msg txt-title-s3 ac-msg-zoom-'+md+' show" style="text-align: left;">'+mb+' <div class="txt-title-s1 msg-time" style="font-size:10px;opacity:0.4;">'+gt(pmt, lds)+'</div></div><br>';

		pmt = ma[m].st;
		pmid = ma[m].id;
	    }
	    t += mt;

	    if (p) { p.innerHTML += t; }
	} break;
    }
    
    // Send read event of not readed
    var mal = ma.length-1;
    if (ro && ((ma[mal].ut == 1 && ma[mal].mid != ApixCloud.CC.API.GetConfig().mid) || (ma[mal].ut != 1 && ma[mal].ut != 10)) && !ma[mal].rt) {
	ApixCloud.CC.API.SendReadNotification(ro.id, ma[mal].id);
	ma[mal].read = 1;
	ma[mal].rt = 1;
    }
};

// Smiley icons
function P3_se(m) {
    var t = m;
    var h, a;
    // :O :-O :o :-o bawl
    if (t.indexOf(':O') > -1 || t.indexOf(':-O') > -1 || t.indexOf(':o') > -1 || t.indexOf(':-o') > -1) {
	a = [':O',':-O',':o',':-o'];
	if (typeof m.trim !== 'undefined' && typeof a.indexOf !== 'undefined') {
	    h = m.trim();
	    if (a.indexOf(h) > -1) h = 'height:40px;margin-left:-3px;';
	    else h = '" class="smiley-s';
	}
	t = t.replace(/(\s)(:O|:-O|:o|:-o)(\s|<|$)/g, '$1<img style="vertical-align: middle;'+h+'" src="/cc/img/FW/jcc-smile-bawl.svg" border="0">$3');
	t = t.replace(/(:O|:-O|:o|:-o)(\s|<|$)/g, '<img style="vertical-align: middle;'+h+'" src="/cc/img/FW/jcc-smile-bawl.svg" border="0">$2');
    }
    // 3:) 3:-) >:) evil
    if (t.indexOf('3:)') > -1 || t.indexOf('3:-)') > -1 || t.indexOf('&gt;:)') > -1) {
	a = ['3:)','3:-)','&gt;:)'];
	if (typeof m.trim !== 'undefined' && typeof a.indexOf !== 'undefined') {
	    h = m.trim();
	    if (a.indexOf(h) > -1) h = 'height:40px;margin-left:-3px;';
	    else h = '" class="smiley-s';
	}
	t = t.replace(/(\s)(3:\)|3:-\)|&gt;:\))(\s|<|$)/g, '$1<img style="vertical-align: middle;'+h+'" src="/cc/img/FW/jcc-smile-evil.svg" border="0">$3');
	t = t.replace(/(3:\)|3:-\)|&gt;:\))(\s|<|$)/g, '<img style="vertical-align: middle;'+h+'" src="/cc/img/FW/jcc-smile-evil.svg" border="0">$2');
    }
    // :) :-) =) happy
    if (t.indexOf(':)') > -1 || t.indexOf(':-)') > -1 || t.indexOf('=)') > -1) {
	a = [':)',':-)','=)'];
	if (typeof m.trim !== 'undefined' && typeof a.indexOf !== 'undefined') {
	    h = m.trim();
	    if (a.indexOf(h) > -1) h = 'height:40px;margin-left:-3px;';
	    else h = '" class="smiley-s';
	}
	t = t.replace(/(\s)(:\)|:-\)|=\))(\s|<|$)/g, '$1<img style="vertical-align: middle;'+h+'" src="/cc/img/FW/jcc-smile-happy.svg" border="0">$3');
	t = t.replace(/(:\)|:-\)|=\))(\s|<|$)/g, '<img style="vertical-align: middle;'+h+'" src="/cc/img/FW/jcc-smile-happy.svg" border="0">$2');
    }
    // <3 heart
    if (t.indexOf('&lt;3') > -1) {
	a = ['&lt;3'];
	if (typeof m.trim !== 'undefined' && typeof a.indexOf !== 'undefined') {
	    h = m.trim();
	    if (a.indexOf(h) > -1) h = 'height:40px;margin-left:0px;';
	    else h = '" class="smiley-s';
	}
	t = t.replace(/(\s)(&lt;3)(\s|<|$)/g, '$1<img style="vertical-align: middle;'+h+'" src="/cc/img/FW/jcc-smile-heart.svg" border="0">$3');
	t = t.replace(/(&lt;3)(\s|<|$)/g, '<img style="vertical-align: middle;'+h+'" src="/cc/img/FW/jcc-smile-heart.svg" border="0">$2');
    }
    // :| :-| innocent
    if (t.indexOf(':|') > -1 || t.indexOf(':-|') > -1) {
	a = [':|',':-|'];
	if (typeof m.trim !== 'undefined' && typeof a.indexOf !== 'undefined') {
	    h = m.trim();
	    if (a.indexOf(h) > -1) h = 'height:40px;margin-left:-3px;';
	    else h = '" class="smiley-s';
	}
	t = t.replace(/(\s)(:\||:-\|)(\s|<|$)/g, '$1<img style="vertical-align: middle;'+h+'" src="/cc/img/FW/jcc-smile-innocent.svg" border="0">$3');
	t = t.replace(/(:\||:-\|)(\s|<|$)/g, '<img style="vertical-align: middle;'+h+'" src="/cc/img/FW/jcc-smile-innocent.svg" border="0">$2');
    }
    // :D :-D =D :)) :-)) laughing
    if (t.indexOf(':D') > -1 || t.indexOf(':-D') > -1 || t.indexOf('=D') > -1 || t.indexOf(':))') > -1 || t.indexOf(':-))') > -1 ) {
	a = [':D',':-D','=D',':))',':-))'];
	if (typeof m.trim !== 'undefined' && typeof a.indexOf !== 'undefined') {
	    h = m.trim();
	    if (a.indexOf(h) > -1) h = 'height:40px;margin-left:-3px;';
	    else h = '" class="smiley-s';
	}
	t = t.replace(/(\s)(:D|:-D|=D|:\)\)|:-\)\))(\s|<|$)/g, '$1<img style="vertical-align: middle;'+h+'" src="/cc/img/FW/jcc-smile-laughing.svg" border="0">$3');
	t = t.replace(/(:D|:-D|=D|:\)\)|:-\)\))(\s|<|$)/g, '<img style="vertical-align: middle;'+h+'" src="/cc/img/FW/jcc-smile-laughing.svg" border="0">$2');
    }
    // @>-->-- rose
    if (t.indexOf('@&gt;--&gt;--') > -1) {
	a = ['@&gt;--&gt;--'];
	if (typeof m.trim !== 'undefined' && typeof a.indexOf !== 'undefined') {
	    h = m.trim();
	    if (a.indexOf(h) > -1) h = 'height:40px;margin-left:0px;';
	    else h = '" class="smiley-s';
	}
	t = t.replace(/(\s)(@&gt;--&gt;--)(\s|<|$)/g, '$1<img style="vertical-align: middle;'+h+'" src="/cc/img/FW/jcc-smile-rose.svg" border="0">$3');
	t = t.replace(/(@&gt;--&gt;--)(\s|<|$)/g, '<img style="vertical-align: middle;'+h+'" src="/cc/img/FW/jcc-smile-rose.svg" border="0">$2');
    }
    // :( :-( =( :(( :-(( sad
    if (t.indexOf(':(') > -1 || t.indexOf(':-(') > -1 || t.indexOf('=(') > -1 || t.indexOf(':((') > -1 || t.indexOf(':-((') > -1) {
	a = [':(',':-(','=(',':((',':-(('];
	if (typeof m.trim !== 'undefined' && typeof a.indexOf !== 'undefined') {
	    h = m.trim();
	    if (a.indexOf(h) > -1) h = 'height:40px;margin-left:-3px;';
	    else h = '" class="smiley-s';
	}
	t = t.replace(/(\s)(:\(\(|:-\(\(|=\(|:\(|:-\()(\s|<|$)/g, '$1<img style="vertical-align: middle;'+h+'" src="/cc/img/FW/jcc-smile-sad.svg" border="0">$3');
	t = t.replace(/(:\(\(|:-\(\(|=\(|:\(|:-\()(\s|<|$)/g, '<img style="vertical-align: middle;'+h+'" src="/cc/img/FW/jcc-smile-sad.svg" border="0">$2');
    }
    // ;) ;-) wink
    if (t.indexOf(';)') > -1 || t.indexOf(';-)') > -1) {
	a = [';)',';-)'];
	if (typeof m.trim !== 'undefined' && typeof a.indexOf !== 'undefined') {
	    h = m.trim();
	    if (a.indexOf(h) > -1) h = 'height:40px;margin-left:-3px;';
	    else h = '" class="smiley-s';
	}
	t = t.replace(/(\s)(;\)|;-\))(\s|<|$)/g, '$1<img style="vertical-align: middle;'+h+'" src="/cc/img/FW/jcc-smile-wink.svg" border="0">$3');
	t = t.replace(/(;\)|;-\))(\s|<|$)/g, '<img style="vertical-align: middle;'+h+'" src="/cc/img/FW/jcc-smile-wink.svg" border="0">$2');
    }
    return t;
}


// Get upload information
// mb, ro
function P3_gui(x1, x2) {
    var mb = x1.split(':');
    var _ud = decodeURIComponent(mb[4]).split('{{-}}');
    var tf = 0;
    var ts = 0;
    var is = [];
    var ai = '<table class="af" border="0"><tbody>';
    for (var _i = 0; _i < _ud.length; _i++) {
	var _fi = _ud[_i].split('{{#}}');
	if (!_fi[0]) continue;
	var li = '';
	if (mb[0] == 'IS') li = '<span class="dl">'+_fi[0]+'</span>';
	if (mb[0] == 'UC') {
	    li = '<a href="/attachment/'+mb[3]+'/'+_fi[0]+'" class="dl"><span class="dl">'+_fi[0]+'</span></a>';
	    if (_fi[0].match(/(\.png|\.jpg|\.jpeg|\.jpe|\.gif)(?=\?|$)/i)) {
		is.push('/attachment/'+mb[3]+'/'+_fi[0]);
	    }
	}
	ai += '<tr> \
		<td style="padding-left:0;width:30px;"><img class="aic" src="'+gai(_fi[0])+'"></td> \
		<td class="fn">'+li+'</td> \
		<td class="fs" style="width:1%;">'+its(_fi[1],1)+'</td></tr>';
	tf++;
	ts += parseInt(_fi[1], 10);
    }
    var ws = '';
    for (var ii = 0; ii < x2.mmbrs.length; ii++) {
	if (x2.mmbrs[ii].u == mb[2] && x2.mmbrs[ii].m == parseInt(mb[1], 10)) {
	    ws = '<span style="margin-right:7px;font-weight:400;">'+ACC.L[366]+'</span> '+ApixCloud.CC.API.GetUserName(null, null, x2.mmbrs[ii])+'<br>';
	    break;
	}
    }
    ai += '<tr><td class="jcc-sm" colspan="3" style="text-align:left;padding:0;padding-top:10px;font-weight:300;"> \
	'+ws+'<span style="margin-right:7px;font-weight:400;">'+ACC.L[357]+'</span> '+tf+', '+ACC.L[356]+' '+its(ts)+'<br> \
	</td></tr></tbody></table>';
    if (x1.indexOf('IS') == 0) {
	ai += 'LOAD...<div id="ccupbw-'+mb[3]+'" class="progress progress-bar-default" style="height:22px"> \
	    <div class="progress-bar" id="ccupb-'+mb[3]+'" style="width:0%;border-radius:10px;"><span style="color:#373e4a" id="ccupbl-'+mb[3]+'"></span></div></div>';
	ai += '<div id="ccufc-'+mb[3]+'" onc1lick="JCC.P3.ion_(this,\''+mb[3]+'\')" style="cursor:pointer;text-align:right;font-size:13px;font-weight:400;display:none;">'+ACC.L[124]+'</div>';
    }
    ai = ACC.L[358]+'<br>'+ai;

    var ip = '';
    if (is && is.length > 0) {
	for (var i = 0; i < is.length; i++) {
	    ip += '<div class="preview"><a href="'+is[i]+'" data-lightbox="ci"><img onload="this.style.background = \'transparent\';" src="'+is[i]+'" class="preview-min"></a></div>';
	}
    }
    if (ip) ai += '<div>'+ip+'</div>';

    return ai;
};

function gt(t, f) {
    if (t == null) return '';
    var cdt = new Date((new Date()).toUTCString());
    var ydt = new Date((new Date()).toUTCString());
    ydt.setUTCDate(ydt.getUTCDate() - 1);
    var dt = new Date(t * 1000);
    var ds, ts;
    var tm = dt.getMinutes();
    if (tm <= 9) { tm = '0' + tm; }

    var pad = function(n){return(n<10)?('0'+n):n;};

    switch (f) {
	// Full present as: 7 August 2013, 18:17
	case 1: {		
		    ds = dt.getDate() + ' ' + ACC.L[37][dt.getMonth()] + ' ' + dt.getFullYear();
		    ts = pad(dt.getHours()) + ':' + tm;
		    return ds + ', ' + ts;
	} break;
	// Time only - HH:MM
	case 2: {		
		    ts = dt.getHours() + ':' + tm;
		    return ts;
	} break;
	// Time only - HH:MM:SS
	case 3: {		
		    var s = dt.getSeconds();
		    if (s <= 9) { s = '0' + s; }
		    ts = dt.getHours() + ':' + tm + ':' + s;
		    return ts;
	} break;
	// Full Date and Time - YYYY-MM-DD HH:mm:ss
	case 4: {
		    var s = dt.getSeconds();
		    var h =  dt.getHours();
		    if (s <= 9) { s = '0' + s; }
		    if (h <= 9) { h = '0' + h; }
		    ts = dt.getFullYear() +'-'+ pad(dt.getMonth()+1) +'-'+ pad(dt.getDate()) +' '+ h +':'+ tm +':'+ s;
		    return ts;
	} break;
	// Time only - HH:MM (with pad zero)
	case 5: {		
		    ts = pad(dt.getHours()) + ':' + tm;
		    return ts;
	} break;
	// Present as defaul format for current CC lang.
	case 6: {
	    var dtf = decodeURIComponent(ApixCloud.CC.API.GetConfig().d_dtf);
	    if (cdt.getUTCFullYear() == dt.getUTCFullYear()) {
		// strip Year
		dtf = dtf.replace(' Y', '').replace('Y ', '');
	    }
	    dtf = dtf.replace('Y', '\''+dt.getFullYear().toString().slice(-2));
	    dtf = dtf.replace('M', ACC.L[38][dt.getMonth()]);
	    dtf = dtf.replace('D', dt.getDate());
	    dtf = dtf.replace('h', dt.getHours());
	    dtf = dtf.replace('m', tm);
	    return dtf;
	} break;
	// format: today at X, yesterday at X, Apr 14 at 16:32, Nov 25 '15 at 7:01
	case 7: {
	    if (cdt.getUTCFullYear() == dt.getUTCFullYear() && cdt.getUTCMonth() == dt.getUTCMonth() && cdt.getUTCDate() == dt.getUTCDate()) {
		// Today at h:m
		return ACC.L[260] + ' ' + ACC.L[262] + ' ' + dt.getHours() + ':' + tm;
	    } else if (ydt.getUTCFullYear() == dt.getUTCFullYear() && ydt.getUTCMonth() == dt.getUTCMonth() && ydt.getUTCDate() == dt.getUTCDate()) {
		// Yesterday at h:m
		return ACC.L[261] + ' ' + ACC.L[262] + ' ' + dt.getHours() + ':' + tm;
	    } else {
		// Date
		return gt(t, 6);
	    }
	} break;
	// format: [ today || yesterday || Apr 14, 16:32 ]
	case 8: {
	    if (cdt.getUTCFullYear() == dt.getUTCFullYear() && cdt.getUTCMonth() == dt.getUTCMonth() && cdt.getUTCDate() == dt.getUTCDate()) {
		// Today at h:m
		return [ACC.L[260], dt.getHours() + ':' + tm];
	    } else if (ydt.getUTCFullYear() == dt.getUTCFullYear() && ydt.getUTCMonth() == dt.getUTCMonth() && ydt.getUTCDate() == dt.getUTCDate()) {
		// Yesterday at h:m
		return [ACC.L[261], dt.getHours() + ':' + tm];
	    } else {
		// Date
		return [gd(t, 3), dt.getHours() + ':' + tm];
	    }
	} break;
	// format: [ today || yesterday || Apr 14, 16:32 ] but for local time
	case 9: {
	    cdt = new Date((new Date()).toString());
	    ydt = new Date((new Date()).toString());
	    ydt.setDate(ydt.getDate() - 1);
	    dt = new Date(t * 1000);
	    tm = dt.getMinutes();
	    if (tm <= 9) { tm = '0' + tm; }

	    if (cdt.getFullYear() == dt.getFullYear() && cdt.getMonth() == dt.getMonth() && cdt.getDate() == dt.getDate()) {
		// Today at h:m
		return [ACC.L[260], dt.getHours() + ':' + tm];
	    } else if (ydt.getFullYear() == dt.getFullYear() && ydt.getMonth() == dt.getMonth() && ydt.getDate() == dt.getDate()) {
		// Yesterday at h:m
		return [ACC.L[261], dt.getHours() + ':' + tm];
	    } else {
		// Date
		return [gd(t, 3), dt.getHours() + ':' + tm];
	    }
	} break;
    }

    return '';
};
function gd(t, f) {
    var dt = new Date(t * 1000);
    var td = new Date();
    
    var pad = function(n){return(n<10)?('0'+n):n;};
    var y = '';

    switch (f) {
	// format: 2014-03-11
	case 0: {
	    return dt.getFullYear() +'-'+ pad(dt.getMonth()+1) +'-'+ pad(dt.getDate());
	} break;
	// format: Wednesday, 2 April 2014
	case 1: {
	    return ACC.L[90][dt.getDay()]+', '+ dt.getDate() + ' ' + ACC.L[37][dt.getMonth()] + ' ' + dt.getFullYear();
	} break;
	// format: April 2, 2014
	case 2: {
	    return ACC.L[79][dt.getMonth()] + ' ' + dt.getDate() + ', ' +  + dt.getFullYear();
	} break;
	// format: Wed, 2 april [2014] (year if different with current)
	case 3: {
	    if (td.getFullYear() != dt.getFullYear()) y = ' ' + dt.getFullYear();
	    return ACC.L[91][dt.getDay()]+', '+ dt.getDate() + ' ' + ACC.L[38][dt.getMonth()] + y;
	} break;
    }

    return '';
};


// Integer to size
function its(s, v) {
    var r = '';
    if (!s || s < 0) return '';
    if (s < 1024) { if (!v) r = s + ' ' + ACC.L[353]; else r = s + ' ' + ACC.L[362]; } // byte(s) or B
    else if (s < 1024*1024) { r = (s / (1024)).toFixed(1) + ' ' + ACC.L[354]; } // KB
    else if (s < 1024*1024*1024) { r = (s / (1024*1024)).toFixed(1) + ' ' + ACC.L[355]; } // MB
    return r.replace('.0 ', ' ');
};
// Get extension icon
function gai(e) {
    var ae = e.substring(e.lastIndexOf('.')+1, e.length);
    if (e.lastIndexOf('.') == -1) ae = '';
    var ei = '';
    switch(ae.toLowerCase()) {
	case 'ai': { ei = 'ai.'; } break;
	case 'avi': { ei = 'avi.'; } break;
	case 'css': { ei = 'css.'; } break;
	case 'doc': { ei = 'doc.'; } break;
	case 'docx': { ei = 'docx.'; } break;
	case 'eps': { ei = 'eps.'; } break;
	case 'htm':
	case 'html': { ei = 'html.'; } break;
	case 'jpeg': { ei = 'jpeg.'; } break;
	case 'jpg': { ei = 'jpg.'; } break;
	case 'mp3': { ei = 'mp3.'; } break;
	case 'pdf': { ei = 'pdf.'; } break;
	case 'png': { ei = 'png.'; } break;
	case 'ppt': { ei = 'ppt.'; } break;
	case 'pptx': { ei = 'pptx.'; } break;
	case 'psd': { ei = 'psd.'; } break;
	case 'rar': { ei = 'rar.'; } break;
	case 'wav': { ei = 'wav.'; } break;
	case 'xls': { ei = 'xls.'; } break;
	case 'xlsx': { ei = 'xlsx.'; } break;
	case 'zip': { ei = 'zip.'; } break;
	case '':
	default: { ei = 'attachment.'; } break;
    }
    return '/img/ei/'+ei+'svg';
};

// Update User List
	function UpdateUserList() {
	    var all_admins = '';
	    var ol = ApixCloud.CC.API.GetUsers();
	    var dl = ApixCloud.CC.API.GetDepartments();
	    var k = Object.keys(ol);
	    var dn;
	    // Loop admins by object keys
	    for (var a = 0; a < k.length; a++) { // >
	        var a_position = '';
	        var a_name = '';

	        // Dont display admins with status Helper. (Its system users)
	        if (ol[k[a]].helper) continue;
	        // Dont display my
	        if (k[a] == ApixCloud.CC.API.GetConfig().mid) continue;

	        a_name = ApixCloud.CC.API.GetUserName(k[a]);
	        if (ol[k[a]].pn != null) {
        		a_position = decodeURIComponent(ol[k[a]].pn);
		}
		var a_avatar = 'https://'+cloud_addr+'/avatar'+ol[k[a]].ap;
		var indicator = '<div class="indicator offline" id="admin-ind-'+k[a]+'"></div>';
		// Add admin
		if (ol[k[a]].st != 0) {
		    indicator = '<div class="indicator signin" id="admin-ind-'+k[a]+'"></div>';
		}
		if (ol[k[a]].was == 1) { indicator = '<div class="indicator online" id="admin-ind-'+k[a]+'"></div>'; }

		// Loop departments to get name
		dn = '';
		for (var d = 0; d < dl.length; d++) { // >
		    if (dl[d].gid == ol[k[a]].gid) dn = dl[d].name;
		}

		all_admins += '<div class="admin-block" onclick="UserClick('+k[a]+')">'+indicator+'<img class="avatar" style="float:left" src="'+a_avatar+'"><div>'+a_name+'</div><div>'+a_position+'</div><div>'+decodeURIComponent(dn)+'</div></div>';
	    }
	    document.getElementById('admins').innerHTML = all_admins;

	    // Update home screen, set open name and avatar
	    // Get My Name
	    var name_surname = ApixCloud.CC.API.GetUserName(ApixCloud.CC.API.GetConfig().mid);
	    var avatar = 'https://'+cloud_addr+'/avatar'+ol[ApixCloud.CC.API.GetConfig().mid].ap+')';
console.log(name_surname);
console.log(avatar);
	}

	// UserClick. Click on user.
	function UserClick(d) {
	    // Action
	    // If we chatting with this user - open dialog
	    // else - open empty chat
	    var rl = ApixCloud.CC.API.GetChatRooms();
	    var k = Object.keys(rl);
	    var me = ApixCloud.CC.API.GetConfig().mid;
	    if (k && k.length > 0) for (var i = 0; i < k.length; i++) { //>
		if (rl[k[i]].s == 1 &&
		    ((rl[k[i]].sid == me && rl[k[i]].sut == 1 && rl[k[i]].rid == d && rl[k[i]].rut == 1) ||
		    (rl[k[i]].sid == d && rl[k[i]].sut == 1 && rl[k[i]].rid == me && rl[k[i]].rut == 1))) {
		    // Found dialog with user and me
		    var dti = ApixCloud.CC.API.GetDialogTitleInfo(k[i], rl[k[i]]);
		    OpenDialog(k[i], dti.ut, dti.id, encodeURIComponent(dti.tt), dti.ts, dti.ap);
		    return;
		}
	    }
	    // If not found room, lets open empty
	    var dti = ApixCloud.CC.API.GetNewDialogTitleInfo(d, 1);
	    OpenDialog(0, dti.ut, dti.id, encodeURIComponent(dti.tt), dti.ts, dti.ap);
	}

// Update Queues
	function UpdateVirtualQueuesList() {
	    var o;
	    var q = ApixCloud.CC.API.GetVirtualQueues();
	    var k = Object.keys(q);
	    // get chats list for queues

	    // Add queue to DOM
	    o = document.getElementById('jcc-qc-cnt');
	    if (!o) return;
	    o.innerHTML = ''; // clear current queue list
    	    for (var i = 0; i < k.length; i++) {
		var n = document.createElement('div');
		n.setAttribute('id', 'queue-btn-'+q[k[i]].id);
		n.className = 'queue';
		n.innerHTML = '<div class="jcc-dep-ind" style="left:10px;right:auto;display:inline-block;padding:10px 20px;">@</div><span id="queue-btn-t-'+q[k[i]].id+'" class="cc-m-dep-title">'+ decodeURIComponent(q[k[i]].qn)+'</span>';
		o.appendChild(n);
		n = document.createElement('div');
		n.setAttribute('id', 'queue-cnt-'+q[k[i]].id);
		o.appendChild(n);
	    }

	    UpdateQueuedChats();
	}

// Update queued chats
function UpdateQueuedChats() {
    var nac = ApixCloud.CC.API.GetQueuedChats();
    var k = Object.keys(nac);
    for (var i = 0; i < k.length; i++) {
        qmc(k[i]);
    }
}


// Update dialog list
function UpdateDialogList() {
    var rl = ApixCloud.CC.API.GetChatRooms();

    if (!rl) return;
    var o;

    // clear list
    document.getElementById('my_dialogs').innerHTML = '';
    // Loop thru rooms and display not closed
    var k = Object.keys(rl);
    var current_chat_agent;
    var ca;
    if (k && k.length > 0) for (var i = 0; i < k.length; i++) {
	ca = ddt1(k[i], rl[k[i]], 'btn');
	if (ca != -1 && k[i] == sel_rid) current_chat_agent = ca;
    }

    // Update current dialog top panel
    // It need to show how do it, but no need to update it while show My dialogs in mobile.
    if (sel_rid > 0 && current_chat_agent) {
	o = document.getElementById('dialog-head');
	o.innerHTML = DialogPanelHtml(current_chat_agent.ap, current_chat_agent.tt, current_chat_agent.ts);
    }
};

// Send message
function SendMessage() {
    var rid = sel_rid;
    var rl = ApixCloud.CC.API.GetChatRooms();

    if (typeof rl[rid] === 'undefined') { rid = 0; }

    // RID char room id (current or 0 for new chat), SEL_SID (sender) current user id, SEL_SUT current (sender) user type
    ApixCloud.CC.API.SendMessage(rid, sel_sid, sel_sut);
}
// Close Chat Room
function CloseChatRoom() {
    if (sel_rid > 0) ApixCloud.CC.API.CloseChatRoom(sel_rid);
}

// Requests, search, history
function P3_r2(d) {
    // If it history or not closed room, insert it into special element with limited back notices (read, delivery), only for e=dialog-s2
    if (d.e && d.e.length > 0) {
	if (d.e == 'tabs') {
	    UpdateDialogList();
	    return;
	}
	if (d.e == 'ar') {
	    // Display chat
	    if (sel_rid == d.r.id) {
		P3_d3(sel_rid);
	    }
	    return;
	}
    }
};

// Notifies
function P3_n1(d) {
    var o;

    switch(d.n) {
	// Message transfer notify
	case 10: {
	    document.getElementById('dialog-input').value = '';
	} break;
	// Member join conversation
	case 15: {
	    // TODO
	} break;
	// Message read notify
	case 20: {

	} break;
	// Message delivered notify
	case 30: {
	} break;
	// Typing notify.
	case 40: {
	    // add "typing..." and if text avail, show text too
console.log('th 1');
	    if (sel_rid == d.r) {
console.log('th 2');
		P3_st(d.r);
	    }
	} break;
	// Conference invite notify
	case 50: {
	    // 1. Show modal confirmation
	    ConfirmConferenceInviting(d);
	} break;
	// Admin close room
	case 60: {
	    // Admin leaved room or visitor leave site, so update dialog list

	    UpdateDialogList()
	    if (sel_rid == d.r) {

		// Go to Home screen

		document.getElementById('dialog').innerHTML = '';
		document.getElementById('dialog-head').innerHTML = 'Chat';
		sel_rid = 0;
		sel_sid = 0;
		sel_sut = 0;
	    }
	} break;
	// Room closed coz visitor leave a website
	case 62: {
	    // DM-2: do not close dialog when visitor leave site
	    return;
	} break;
	// Uploading: progress
	case 70: {
	    // show cancel if I uploading file
	    o = document.getElementById('ccufc-'+d.h);
	    if (o && o.style.display != 'block' && d.ut == 1 && d.mid == ApixCloud.CC.API.GetConfig().mid) {
		o.style.display = 'block';
	    }
	    // Update progress, find progress bar by id like 'ccupb-9c4eb7319478184f7926726de9df3355'
	    o = document.getElementById('ccupb-'+d.h);
	    if (o) {
console.log('70 ------- progress '+d.p+'%');
		o.style.width = d.p+'%';
		// Text annotaton. % of upload or Wait while uploaded files moving to cloud.
		o = document.getElementById('ccupbl-'+d.h);
		if (o) {
		    if (d.p < 100) o.innerHTML = '&nbsp;'+ACC.L[368].replace('%p%', d.p)+'&nbsp;';	// >
		    else o.innerHTML = ACC.L[369];
		}
	    }
	} break;
	// Uploading: abort / error
	case 75: {
	    var msg;
	    if (d.c == 'SA') { msg = ACC.L[359]; }
	    if (d.c == 'SE') {
		switch (d.hs) {
		    case 413: { msg = ACC.L[360]; } break;
		    default: { msg = ACC.L[361]; } break;
		}
	    }
	    if (d.ut == 1 && d.mid == ApixCloud.CC.API.GetConfig().mid) alert(ACC.L[57]+' - '+msg); //JCC.m(JCC.L[57], msg, 4, 1);
	    _e_ifs = null;
	    var o = document.getElementById('cuft-'+d.h);
	    if (o && msg) {
		o.innerHTML = '<div style="margin-top:10px;font-weight:400;color:#ee4749;">'+msg+'</div>';
	    }
	} break;
	// Visitor block/unblock
	case 80: {
	} break;
	// Form to visitor was sent
	case 90: {
	    // Replace Send button with text
	    o = document.getElementById('cc-svf-'+d.fid);
	    if (o) o.parentNode.innerHTML = '<div style="margin-top:20px;">'+ACC.L[287]+'</div>';
	} break;
    }
};

// Show typing hint
function P3_st(r) {
    var rl = ApixCloud.CC.API.GetChatRooms();
    var ol = ApixCloud.CC.API.GetUsers();
    if (typeof rl[r] === 'undefined') return;
    var t = '', t1;
    var o = document.getElementById('typing-hint');

    for (var k in rl[r].th) {
    	// try to find table or add new
    	t = rl[r].th[k];
	var a = k.split('-');

	var mb = decodeURIComponent(t);
	// Replace tag to stringable
	mb=mb.replace(/</g,'&lt;');mb=mb.replace(/>/g,'&gt;');
	// Replace \n to <br>
	mb=mb.replace(/\n/g,'<br>');
	// smiley
    	if (ApixCloud.CC.API.GetConfig().sse == '1' && mb != '') { mb = P3_se(mb); }
	// hilight links & show images
	mb = ApixCloud.CC.API.DetectDataInMessage(mb) + ' ';

	t1 = '';

	if (typeof rl[r].m !== 'undefined' && rl[r].m.length > 2) {
	    //a[0] = ut, a[1] = mid, a[2] = domid
	    if (a[0] == 1) {
		t1 = '<span class="txt-title-s2" style="font-weight: bold;">' + decodeURIComponent(ol[a[1]].fn) + ' ' + ACC.L[41];
		if (mb == '') {
		    t1 += '<span class="dot1">.</span><span class="dot2">.</span><span class="dot3">.</span>';
		}
		t1 += '</span><br>';
	    }
	    if (a[0] == 2) {
		t1 = '<span class="txt-title-s2" style="font-weight: bold;">' + ApixCloud.CC.API.GetUserName(null, a[1]+'-'+a[2]) + ' ' + ACC.L[41];
		if (mb == '') {
		    t1 += '<span class="dot1">.</span><span class="dot2">.</span><span class="dot3">.</span>';
		}
		t1 += '</span><br>';
	    }
	} else {
	    if (mb == '') {
		t1 = '<span class="txt-title-s2" style="font-weight: bold;"><span class="dot1">.</span><span class="dot2">.</span><span class="dot3">.</span></span>';
	    } else {
		t1 = '';
	    }
	}
	if (mb != '') {
	    t1 += '<div class="txt-title-s2">' + mb + '<div class="ac-caret">&nbsp;</div></div>';
	}

	o.innerHTML = t1;
	o.style.display = 'block';

	// if no hint text - hide hint
	if (!t || t == '') {
	    var _tk = 'th_st_'+a[0]+'_'+a[1];
	    if (rl[r][_tk]) { clearTimeout(rl[r][_tk]); }
	    rl[r][_tk] = setTimeout(function (_r, _a){ return function() {
		var rr = _r;
		var u = _a[0];
		var m = _a[1];
		if (u == '2') m = _a[1]+'-'+_a[2];
		if (sel_rid == rr && (typeof rl[rr] === 'undefined' || typeof rl[rr].th === 'undefined' || rl[rr].th[u+'-'+m] === 'undefined' || rl[rr].th[u+'-'+m] == '')) {
		    var e = document.getElementById('typing-hint');
		    if (e) { e.innerHTML = ''; e.style.display = 'none'; }
		}
		if (typeof rl[rr] !== 'undefined' && typeof rl[rr].th !== 'undefined' && rl[rr].th[u+'-'+m] == '') delete rl[rr].th[u+'-'+m];
	    };}(r, a), 5000);
	}
    }
};

function ConfirmConferenceInviting(d) {
    //var f1 = function(_x1, _x2, _x3, _x4) { return function() { JCC.P3.cca(_x1, _x2, _x3, _x4, 1);}; }(d.r, d.sid, d.sut, d.mid);
    //var f2 = function(_x1, _x2, _x3, _x4) { return function() { JCC.P3.cca(_x1, _x2, _x3, _x4, 0);}; }(d.r, d.sid, d.sut, d.mid);
    //JCC.m(, , 'jcc-dialog-conference-icon.svg', 3, f1, f2, null, 1);
    var fDecline = 'onclick="ApixCloud.CC.API.ConferenceCallAnswer('+d.r+',\''+d.sid+'\','+d.sut+','+d.mid+', 0);document.body.removeChild(document.getElementById(\'conf-confirm\'))"';
    var fAccept = 'onclick="ApixCloud.CC.API.ConferenceCallAnswer('+d.r+',\''+d.sid+'\','+d.sut+','+d.mid+', 1);document.body.removeChild(document.getElementById(\'conf-confirm\'))"';
    var html = '<div style="border-radius: 3px;box-shadow: 0px 3px 10px rgba(0,0,0,0.3);position: absolute;top: 20px;left: 20px;background: #A5A5FF;padding:20px;"><div style="font-weight: 600;margin-bottom: 10px;">'+ACC.L[67]+'</div><div>'+ACC.L[50].replace('%person%', ApixCloud.CC.API.GetUserName(d.sid))+'</div><br><div style="text-align: right;"> \
	<div '+fDecline+' style="cursor:pointer;display: inline-block;background: #D2D2D2;padding: 5px 15px;border-radius: 20px;color: #5F5F5F;">'+ACC.L[52]+'</div> \
	<div '+fAccept+' style="cursor:pointer;display: inline-block;background: #07A700;padding: 5px 15px;border-radius: 20px;color: white;margin-left: 20px;">'+ACC.L[51]+'</div></div></div>';

    var e = document.createElement('div');
    e.innerHTML = html;
    e.setAttribute('id', 'conf-confirm');
    document.body.appendChild(e);
};

function DialogInfoMenu() {
    // Close if openned
    var ip = document.getElementById('dialog-info');
    if (ip) {
	ip.parentNode.removeChild(ip);
	return;
    }

    // Display info depend on chat room or selected User
    // - Chat with User
    // - Chat with Visitor
    // - Conference
    var html = '';
    var rl = ApixCloud.CC.API.GetChatRooms();

    if (typeof rl[sel_rid] !== 'undefined') {
	if (rl[sel_rid].s == 1) {
	    var dti = ApixCloud.CC.API.GetDialogTitleInfo(sel_rid, rl[sel_rid]);
console.log('dti');
console.log(dti);
	    // Conversation with User
	    if (dti.ut == 1 && dti.id > 0) {
		html = BuildConversationUserPopoverHTML(dti.id);
		// Request API for User info
		ApixCloud.CC.API.GetUserStatistics(sel_sid);
	    }
	    // Conversation with Visitor
	    // TODO
	}
	if (rl[sel_rid].s == 2) {
	    // Conference info
	    html = '<div>Conference</div>';
	}
    } else {
	// Show info about selected User
	if (sel_sid > 0 && sel_sut == 1) {
	    html = BuildConversationUserPopoverHTML(sel_sid);
	    // Request API for User info
	    ApixCloud.CC.API.GetUserStatistics(sel_sid);
	}
    }
    if (html) {
	var e = document.createElement('div');
	e.innerHTML = html;
	e.setAttribute('id', 'dialog-info');
	e.setAttribute('style', 'overflow: auto;position: absolute;top: 0;left: 0;bottom: -47px;right: 60px;background: #373E4A;background: -webkit-linear-gradient(-45deg, #4b515c 0%,#373e4a 100%);box-shadow: 0px 0px 15px rgba(0,0,0,0.7);color: white;padding: 20px;');
	document.getElementById('dialog-head').parentNode.appendChild(e);
    }
};

function BuildConversationUserPopoverHTML(sid) {
	    var ol = ApixCloud.CC.API.GetUsers();
	    var og = ApixCloud.CC.API.GetDepartments();
	    var on = ApixCloud.CC.API.GetUserName(sid);
	    var oa = 'https://'+cloud_addr+'/avatar'+ol[sid].ap;
	    var op = decodeURIComponent(ol[sid].pn);
	    var od = '';
	    if (og && og.length > 0) {
		for (var i = 0; i < og.length; i++) {
		    if (ol[sid].gid == og[i].gid) {
			od = decodeURIComponent(og[i].name);
			break;
		    }
		}
	    }

	    var html = '<div id="user_popover_'+sid+'" style="text-align: center;"><img class="avatar" style="width: 60px;height: 60px;" src="'+oa+'"></div><div style="/* font-size: 12px; */margin-top: 10px;opacity: 1.5;text-align: center;">'+on+'</div><div style="font-size: 12px;margin-bottom: 0px;margin-top: 5px;/* opacity: 0.5; */text-align: center;">'+od+'</div><div style="font-size: 12px;margin-bottom: 10px;/* margin-top: 5px; *//* opacity: 0.5; */text-align: center;">'+op+'</div><hr style="border: 0;border-top: 1px solid rgba(255,255,255,0.2);margin-left: -20px;margin-right: -20px;margin-top: 20px;"> \
		<div style="margin: 15px 0px;"> \
		    <div style="display: inline-block;float: left;margin: 10px 0;">#</div> \
		    <div style="display: inline-block;padding: 0px 20px;font-size: 14px;">'+ACC.L[289]+'<br><span style="font-size: 11px;">'+ACC.L[537][0]+'</span></div> \
		    <div style="display: inline-block;float: right;margin: 10px 0;" id="user_popover_chats_'+sid+'"></div> \
		    <hr style="border: 0;border-top: 1px solid rgba(255,255,255,0.2);margin-right: -20px; margin-left: 28px; margin-top: 15px;"> \
		</div> \
		<div style="margin: 15px 0px;"> \
		    <div style="display: inline-block;float: left;margin: 10px 0;">#</div> \
		    <div style="display: inline-block;padding: 0px 20px;font-size: 14px;">'+ACC.L[291]+'<br><span style="font-size: 11px;">'+ACC.L[537][1]+'</span></div> \
		    <div style="display: inline-block;float: right;margin: 10px 0;" id="user_popover_mdc_'+sid+'"></div> \
		    <hr style="border: 0;border-top: 1px solid rgba(255,255,255,0.2);margin-right: -20px;margin-left: 28px;margin-top: 15px;"> \
		</div> \
		<div style="margin: 15px 0px;"> \
		    <div style="display: inline-block;float: left;margin: 10px 0;">#</div> \
		    <div style="display: inline-block;padding: 0px 20px;font-size: 14px;">'+ACC.L[290]+'<br><span style="font-size: 11px;">'+ACC.L[537][2]+'</span></div> \
		    <div style="display: inline-block;float: right;margin: 10px 0;" id="user_popover_mqc_'+sid+'"></div> \
		    <hr style="border: 0;border-top: 1px solid rgba(255,255,255,0.2);margin-right: -20px;margin-left: 28px;margin-top: 15px;"> \
		</div> \
		<div style="margin: 15px 0px;"> \
		    <div style="display: inline-block;float: left;margin: 10px 0;">#</div> \
		    <div style="display: inline-block;padding: 0px 20px;font-size: 14px;">'+ACC.L[292]+'<br><span style="font-size: 11px;">'+ACC.L[537][3]+'</span></div> \
		    <div style="display: inline-block;float: right;margin: 10px 0;" id="user_popover_rating_'+sid+'"></div> \
		    <hr style="border: 0;border-top: 1px solid rgba(255,255,255,0.2);margin-right: -20px;margin-left: 28px;margin-top: 15px;"> \
		</div> \
		<div style="margin: 15px 0px;"> \
		    <div style="display: inline-block;float: left;margin: 10px 0;">#</div> \
		    <div style="display: inline-block;padding: 0px 20px;font-size: 14px;">'+ACC.L[538][0]+'<br><span style="font-size: 11px;">'+ACC.L[537][4]+'</span></div> \
		    <div style="display: inline-block;float: right;margin: 10px 0;" id="user_popover_tu_'+sid+'"></div> \
		    <hr style="border: 0;border-top: 1px solid rgba(255,255,255,0.2);margin-right: -20px;margin-left: 28px;margin-top: 15px;"> \
		</div> \
		<div style="margin: 15px 0px;"> \
		    <div style="display: inline-block;float: left;margin: 10px 0;">#</div> \
		    <div style="display: inline-block;padding: 0px 20px;font-size: 14px;">'+ACC.L[538][1]+'<br><span style="font-size: 11px;">'+ACC.L[537][4]+'</span></div> \
		    <div style="display: inline-block;float: right;margin: 10px 0;" id="user_popover_td_'+sid+'"></div> \
		    <hr style="border: 0;border-top: 1px solid rgba(255,255,255,0.2);margin-right: -20px;margin-left: 28px;margin-top: 15px;"> \
		</div> \
		<div style="margin: 15px 0px;"> \
		    <div style="display: inline-block;float: left;margin: 10px 0;">#</div> \
		    <div style="display: inline-block;padding: 0px 20px;font-size: 14px;">'+ACC.L[294]+'<br><span style="font-size: 11px;">'+ACC.L[537][5]+'</span></div> \
		    <div style="display: inline-block;float: right;margin: 10px 0;" id="user_popover_aat_'+sid+'"></div> \
		    <hr style="border: 0;border-top: 1px solid rgba(255,255,255,0.2);margin-right: -20px;margin-left: 28px;margin-top: 15px;"> \
		</div> \
		<div style="margin: 15px 0px;"> \
		    <div style="display: inline-block;float: left;margin: 10px 0;">#</div> \
		    <div style="display: inline-block;padding: 0px 20px;font-size: 14px;">'+ACC.L[295]+'<br><span style="font-size: 11px;">'+ACC.L[537][6]+'</span></div> \
		    <div style="display: inline-block;float: right;margin: 10px 0;" id="user_popover_art_'+sid+'"></div> \
		    <hr style="border: 0;border-top: 1px solid rgba(255,255,255,0.2);margin-right: -20px;margin-left: 28px;margin-top: 15px;"> \
		</div>';

    return html;
}

</script>


</head>
<body onload="ready();">
    <h3 style="color: #404040;padding-left: 5px;">Contact Center Example</h3>
    <div class="row" style="width:27%;display:inline-block;vertical-align:top;">
	<div class="title">1. Sign In process.</div>
	<p>Send login information.<br>OnSuccess, get CC config, list of operators, queues, active chats ...</p>
	<div class="btn" onclick="sign_in()">Sign In</div>
    </div>
    <div class="row" style="width:27%;display:inline-block;vertical-align:top;">
	<div class="title">2. Turn on Web-Online mode.</div>
	<p>Turn on Web-Online mode and receive current website(s) visitors and not closed chats with visitors ...</p>
	<div class="btn" onclick="cas()">Web-Online</div>
    </div>
    <div class="row" style="width:27%;display:inline-block;vertical-align:top;">
	<div class="title">3. Sign Out process.</div>
	<p>Close session ...</p>
	<div class="btn" onclick="sign_out()">Sign Out</div>
    </div>
    <div>
	<div class="screen">
	    <div class="refresh" onclick="UpdateUserList();">refresh</div>
	    <div class="head">Сотрудники</div>
	    <div class="body" id="admins"></div>
	</div>
	<div class="screen">
	    <div class="refresh" onclick="UpdateVirtualQueuesList();">refresh</div>
	    <div class="head">Очереди</div>
	    <div class="body" id="queues"><div id="jcc-qc-cnt" style="p111adding-bottom: 5px; display: block;"></div></div>
	</div>
	<div class="screen">
	    <div class="refresh" onclick="UpdateDialogList()">refresh</div>
	    <div class="head">Мои диалоги</div>
	    <div class="body" id="my_dialogs"></div>
	</div>
	<div class="screen">
	    <div class="refresh" onclick="">refresh</div>
	    <div class="head" id="dialog-head">Чат</div>
	    <div class="body" id="dialog" style="height: 374px;"></div>
	    <div id="typing-hint" style="display:none;position: absolute;top: 65px;left: 10px;right: 10px;border-radius: 10px;background: rgba(0,0,0,0.1);padding:10px;"></div>
	    <div style="position: absolute;bottom:-47px;left: 0px;right: 0px;background: #E8E8E8;padding: 3px 0px;border: 1px solid silver;">
		<table style="width:100%;"><tbody><tr>
		    <td style="width: 1%;padding: 0px 10px;">@</td>
		    <td><textarea id="dialog-input" style="display:block;width:100%;border-radius:26px;resize:none;padding:2px 5px;outline:none;border: 0;-webkit-box-shadow:none;-moz-box-shadow: none;box-shadow: none;"></textarea></td>
		    <td style="width: 1%;padding: 0px 15px;"><div onclick="SendMessage()" style="background: #7E7EFB;border-radius: 14px; height: 28px; width: 28px; text-align: center; line-height: 34px;color: white;">^</div></td>
		</tr></tbody></table></div>
	</div>
    </div>
</body></html>
